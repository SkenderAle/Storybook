
import React, { useState, useRef, useEffect } from 'react';
import { createRoot } from 'react-dom/client';
import { GoogleGenAI, Type } from "@google/genai";

// --- Costanti e Tipi ---
enum ImageStyle {
  REALISTIC = 'realistico',
  FUTURISTIC = 'futuristico',
  MANGA = 'manga',
  PENCIL = 'matita',
  DISNEY = 'fumetto disneyano',
  OIL = 'pittura a olio',
  WATERCOLOR = 'acquerello'
}

const STYLE_PROMPTS: Record<ImageStyle, string> = {
  [ImageStyle.REALISTIC]: "Professional photography style, cinematic lighting, 8k, highly realistic, masterpiece quality",
  [ImageStyle.FUTURISTIC]: "Sci-fi concept art, neon lighting, high-tech, futuristic atmosphere, intricate digital art",
  [ImageStyle.MANGA]: "Modern Japanese manga illustration, clean lines, vibrant cel-shading, professional anime art",
  [ImageStyle.PENCIL]: "Detailed graphite pencil sketch, artistic hand-drawn style, textured paper, professional shading",
  [ImageStyle.DISNEY]: "3D animation style, expressive characters, soft global illumination, vibrant colors, Pixar-inspired",
  [ImageStyle.OIL]: "Classic oil painting, visible brushstrokes, rich textures, traditional art masterpiece",
  [ImageStyle.WATERCOLOR]: "Artistic watercolor painting, soft edges, ink details, beautiful paper texture"
};

const FONTS = [
  { name: 'Scrittura', value: 'font-patrick' },
  { name: 'Leggibile', value: 'font-opendyslexic' },
  { name: 'Pulito', value: 'font-andika' },
  { name: 'Artistico', value: 'font-amatic' },
  { name: 'Classico', value: 'font-playfair' }
];

interface StoryPage {
  id: string;
  text: string;
  imageUrl: string;
  isLoading: boolean;
}

// --- Componente Principale ---
const App = () => {
  const [hasKey, setHasKey] = useState<boolean | null>(null);
  const [pages, setPages] = useState<StoryPage[]>([]);
  const [title, setTitle] = useState('La mia ricerca');
  const [author, setAuthor] = useState('');
  const [prompt, setPrompt] = useState('');
  const [numPages, setNumPages] = useState(5);
  const [currentIndex, setCurrentIndex] = useState(-1); 
  const [currentStyle, setCurrentStyle] = useState<ImageStyle>(ImageStyle.DISNEY);
  const [isProcessing, setIsProcessing] = useState(false);
  const [status, setStatus] = useState('');
  
  const [settings, setSettings] = useState({
    fontFamily: 'font-andika',
    fontSize: 22,
    textColor: '#1e293b'
  });

  const importRef = useRef<HTMLInputElement>(null);

  // --- Inizializzazione Chiave API ---
  useEffect(() => {
    const checkKey = async () => {
      const selected = await window.aistudio.hasSelectedApiKey();
      setHasKey(selected);
    };
    checkKey();
  }, []);

  const handleSelectKey = async () => {
    await window.aistudio.openSelectKey();
    setHasKey(true); // Procediamo assumendo successo come da istruzioni
  };

  // --- Logica AI ---
  const generateContent = async () => {
    if (!prompt.trim()) return alert("Inserisci un prompt per iniziare!");
    setIsProcessing(true);
    setStatus('L\'AI sta elaborando il contenuto...');
    
    const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
    try {
      const response = await ai.models.generateContent({
        model: 'gemini-3-flash-preview',
        contents: `Genera un contenuto strutturato sull'argomento: "${prompt}". 
        Suddividilo in esattamente ${numPages} sezioni sequenziali. 
        Se √® una ricerca (es: Sudafrica), sviscera l'argomento in modo professionale.
        Se √® una storia, rendila avvincente.
        Ritorna un array JSON di stringhe, senza markdown.`,
        config: {
          responseMimeType: "application/json",
          responseSchema: {
            type: Type.ARRAY,
            items: { type: Type.STRING }
          }
        }
      });

      const texts = JSON.parse(response.text || "[]");
      const newPages = texts.map((t: string) => ({
        id: Math.random().toString(36).substr(2, 9),
        text: t,
        imageUrl: '',
        isLoading: false
      }));
      
      setPages(newPages);
      setCurrentIndex(0);
      setStatus(`Testo generato (${newPages.length} pagine).`);
    } catch (err) {
      console.error(err);
      setStatus('Errore generazione testo.');
    } finally {
      setIsProcessing(false);
    }
  };

  const generateImageForPage = async (index: number) => {
    const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
    const up = [...pages];
    up[index].isLoading = true;
    setPages([...up]);

    try {
      const response = await ai.models.generateContent({
        model: 'gemini-3-pro-image-preview', // High Quality Mode
        contents: { 
          parts: [{ text: `High quality book illustration: "${up[index].text}". Style: ${STYLE_PROMPTS[currentStyle]}. Masterpiece.` }] 
        },
        config: { 
          imageConfig: { aspectRatio: "1:1", imageSize: "1K" }
        }
      });

      const imgPart = response.candidates?.[0]?.content?.parts.find(p => p.inlineData);
      if (imgPart?.inlineData) {
        up[index].imageUrl = `data:image/png;base64,${imgPart.inlineData.data}`;
      }
    } catch (err) {
      console.error(err);
    } finally {
      up[index].isLoading = false;
      setPages([...up]);
    }
  };

  const generateAllImages = async () => {
    if (pages.length === 0) return;
    setIsProcessing(true);
    for (let i = 0; i < pages.length; i++) {
      setStatus(`Elaborazione immagine ${i + 1}/${pages.length}...`);
      await generateImageForPage(i);
    }
    setIsProcessing(false);
    setStatus('Libro completato! ‚ú®');
    setTimeout(() => setStatus(''), 4000);
  };

  // --- Export / Import ---
  const exportProject = () => {
    if (pages.length === 0) return alert("Genera del contenuto prima di esportare.");
    const data = { title, author, pages, settings, currentStyle, prompt, numPages };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    // Nome file pulito basato sul titolo attuale
    const fileName = (title || 'progetto_libro')
      .trim()
      .toLowerCase()
      .replace(/[^a-z0-9]/gi, '_')
      .concat('.json');

    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    a.click();
    URL.revokeObjectURL(url);
  };

  const importProject = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      try {
        const d = JSON.parse(ev.target?.result as string);
        setTitle(d.title || '');
        setAuthor(d.author || '');
        setPages(d.pages || []);
        setSettings(d.settings || settings);
        setCurrentStyle(d.currentStyle || ImageStyle.DISNEY);
        setPrompt(d.prompt || '');
        setNumPages(d.numPages || d.pages?.length || 5);
        setCurrentIndex(-1);
      } catch (err) { alert("File JSON non valido."); }
    };
    reader.readAsText(file);
    e.target.value = '';
  };

  // --- UI Components ---
  if (hasKey === false) {
    return (
      <div className="h-screen w-full flex flex-col items-center justify-center bg-slate-900 text-white p-10 text-center">
        <div className="max-w-md space-y-8">
          <div className="text-6xl mb-6">üìñ</div>
          <h1 className="text-4xl font-amatic font-bold tracking-widest">SBLOCCA IL POTERE DELL'AI</h1>
          <p className="text-slate-400 text-sm leading-relaxed">
            Per generare ricerche e illustrazioni ad alta qualit√† (Gemini 3 Pro), √® necessario selezionare una chiave API valida con fatturazione attiva.
          </p>
          <button 
            onClick={handleSelectKey}
            className="w-full py-4 bg-indigo-600 hover:bg-indigo-500 rounded-2xl font-bold tracking-widest shadow-2xl transition-all active:scale-95"
          >
            SELEZIONA CHIAVE API
          </button>
          <a href="https://ai.google.dev/gemini-api/docs/billing" target="_blank" className="block text-[10px] text-slate-500 hover:text-indigo-400 underline uppercase tracking-widest">
            Documentazione Fatturazione Google
          </a>
        </div>
      </div>
    );
  }

  const renderSpread = (idx: number) => {
    if (idx === -1) { // Copertina Minimal
      return (
        <div className="book-spread flex-col items-center justify-center p-20 text-center bg-white shadow-2xl border border-slate-100">
          <div className="space-y-10">
            <h1 className="font-playfair text-7xl text-slate-900 uppercase tracking-tighter border-b-2 border-slate-200 pb-10">{title || "Titolo"}</h1>
            <p className="font-patrick text-4xl text-slate-400">di {author || "Autore"}</p>
          </div>
          <div className="absolute bottom-10 text-[9px] text-slate-300 tracking-[0.6em] font-bold uppercase">Copertina</div>
        </div>
      );
    }

    if (idx === -2) { // Retro
      return (
        <div className="book-spread flex-col items-center justify-center p-20 bg-slate-50 text-slate-400 text-center border-l-[20px] border-slate-200 shadow-2xl">
          <div className="text-4xl mb-6 opacity-30">üìñ</div>
          <p className="text-[10px] tracking-[0.5em] font-bold uppercase mb-2">¬© {author || "Autore"} {new Date().getFullYear()}</p>
          <p className="text-[8px] opacity-50 uppercase tracking-widest">Creato con AI Storybook Studio</p>
        </div>
      );
    }

    const page = pages[idx];
    return (
      <div className="book-spread shadow-2xl">
        <div className="book-spine" />
        {/* Testo a Sinistra */}
        <div className="page-side bg-slate-50 border-r border-slate-100 p-16">
          <div 
            className={`w-full text-center outline-none leading-relaxed overflow-y-auto max-h-full scrollbar-hide ${settings.fontFamily}`}
            style={{ fontSize: `${settings.fontSize}px`, color: settings.textColor }}
            contentEditable
            suppressContentEditableWarning
            onBlur={(e) => {
              const up = [...pages];
              up[idx].text = e.currentTarget.innerText;
              setPages(up);
            }}
          >
            {page.text}
          </div>
          <div className="absolute bottom-6 left-8 text-[9px] text-slate-300 font-bold uppercase tracking-widest">Testo</div>
        </div>
        {/* Immagine a Destra */}
        <div className="page-side bg-white p-12">
          {page.isLoading ? (
            <div className="animate-pulse flex flex-col items-center gap-3">
              <div className="w-10 h-10 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
              <span className="text-[9px] font-bold text-indigo-400 uppercase tracking-[0.3em]">Pittura in corso...</span>
            </div>
          ) : page.imageUrl ? (
            <img src={page.imageUrl} className="max-w-full max-h-full object-contain rounded shadow-lg border border-slate-50" />
          ) : (
            <div className="flex flex-col items-center opacity-20">
              <span className="text-8xl mb-4">üé®</span>
              <button onClick={() => generateImageForPage(idx)} className="text-[10px] font-black text-indigo-500 underline uppercase tracking-widest">Genera Immagine</button>
            </div>
          )}
          <div className="absolute bottom-6 right-8 text-[9px] text-slate-300 font-bold uppercase tracking-widest">Pagina {idx + 1}</div>
        </div>
      </div>
    );
  };

  return (
    <div className="flex h-screen w-full bg-slate-100 font-andika">
      {/* Sidebar Strumenti */}
      <aside className="no-print w-80 bg-white border-r flex flex-col shadow-2xl z-50">
        <div className="p-6 bg-slate-900 text-white">
          <h2 className="text-2xl font-amatic font-bold tracking-[0.2em] uppercase">AI StoryStudio</h2>
          <p className="text-[9px] font-bold uppercase opacity-50 tracking-widest">Documentary Creator</p>
        </div>

        <div className="flex-1 overflow-y-auto p-5 space-y-6 custom-scrollbar">
          <section className="space-y-3">
            <h3 className="text-[10px] font-black text-indigo-600 uppercase tracking-widest">1. Info Libro</h3>
            <input type="text" placeholder="Titolo" className="w-full p-2 text-sm border-b outline-none font-bold" value={title} onChange={e => setTitle(e.target.value)} />
            <input type="text" placeholder="Autore" className="w-full p-2 text-sm border-b outline-none" value={author} onChange={e => setAuthor(e.target.value)} />
          </section>

          <section className="space-y-3 pt-2">
            <h3 className="text-[10px] font-black text-indigo-600 uppercase tracking-widest">2. Argomento</h3>
            <textarea 
              placeholder="Es: Sviscera l'argomento Sudafrica... oppure Storia tra Giorgio e Paola..."
              className="w-full h-32 p-3 text-xs border rounded-xl outline-none focus:ring-2 ring-indigo-50 resize-none"
              value={prompt}
              onChange={e => setPrompt(e.target.value)}
            />
            <div className="flex justify-between items-center text-[9px] font-bold uppercase">
              <span className="text-slate-400">Pagine</span>
              <span className="text-indigo-600 font-black">{numPages}</span>
            </div>
            <input type="range" min="1" max="20" className="w-full accent-indigo-600" value={numPages} onChange={e => setNumPages(parseInt(e.target.value))} />
            <button onClick={generateContent} disabled={isProcessing} className="w-full py-3 bg-indigo-600 text-white font-bold text-[10px] rounded-xl uppercase tracking-widest hover:bg-indigo-700 shadow-md">Genera Testo</button>
          </section>

          <section className="space-y-3 border-t pt-5">
            <h3 className="text-[10px] font-black text-emerald-600 uppercase tracking-widest">3. Illustrazioni</h3>
            <select className="w-full p-2 text-xs border rounded-xl outline-none" value={currentStyle} onChange={e => setCurrentStyle(e.target.value as ImageStyle)}>
              {Object.values(ImageStyle).map(s => <option key={s} value={s}>{s.charAt(0).toUpperCase() + s.slice(1)}</option>)}
            </select>
            <button 
              onClick={generateAllImages}
              disabled={isProcessing || pages.length === 0}
              className={`w-full py-3 rounded-xl font-bold text-white text-[10px] uppercase shadow-md transition-all ${isProcessing ? 'bg-slate-300' : 'bg-emerald-600 hover:bg-emerald-700'}`}
            >
              Genera Immagini (PRO)
            </button>
            {status && <p className="text-[9px] text-center font-bold text-indigo-500 animate-pulse uppercase tracking-tighter">{status}</p>}
          </section>

          <section className="space-y-3 border-t pt-5">
            <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Stile Testo</h3>
            <select className="w-full p-2 text-xs border rounded-lg" value={settings.fontFamily} onChange={e => setSettings({...settings, fontFamily: e.target.value})}>
              {FONTS.map(f => <option key={f.value} value={f.value}>{f.name}</option>)}
            </select>
            <input type="range" min="14" max="48" className="w-full accent-slate-400" value={settings.fontSize} onChange={e => setSettings({...settings, fontSize: parseInt(e.target.value)})} />
          </section>
        </div>

        <div className="p-4 border-t bg-slate-50 space-y-2">
          <div className="grid grid-cols-2 gap-2">
            <button onClick={() => importRef.current?.click()} className="py-2 text-[9px] font-bold border rounded-lg bg-white uppercase">Import</button>
            <button onClick={exportProject} className="py-2 text-[9px] font-bold border rounded-lg bg-white uppercase">Export</button>
            <input type="file" ref={importRef} className="hidden" accept=".json" onChange={importProject} />
          </div>
          <button onClick={() => window.print()} className="w-full py-3 bg-slate-800 text-white text-[10px] font-bold rounded-xl uppercase tracking-widest shadow-md">üñ®Ô∏è Stampa PDF</button>
        </div>
      </aside>

      {/* Main Preview Area */}
      <main className="no-print flex-1 flex flex-col items-center justify-center p-12 relative bg-gradient-to-br from-slate-100 to-slate-200">
        <div className="absolute top-10 flex items-center gap-8 z-40">
          <button onClick={() => setCurrentIndex(prev => Math.max(-1, prev - 1))} className="bg-white p-4 rounded-full shadow-2xl hover:scale-110 disabled:opacity-20" disabled={currentIndex === -1}>‚ùÆ</button>
          <div className="bg-white/95 px-10 py-3 rounded-full text-[10px] font-black text-slate-500 shadow-xl border border-white uppercase tracking-[0.3em] min-w-[200px] text-center">
            {currentIndex === -1 ? 'Copertina' : currentIndex === -2 ? 'Fine Libro' : `Pagina ${currentIndex + 1} / ${pages.length}`}
          </div>
          <button onClick={() => {
            if (currentIndex === pages.length - 1) setCurrentIndex(-2);
            else if (currentIndex === -2) return;
            else setCurrentIndex(prev => prev + 1);
          }} className="bg-white p-4 rounded-full shadow-2xl hover:scale-110 disabled:opacity-20" disabled={currentIndex === -2 || (pages.length === 0 && currentIndex === -1)}>‚ùØ</button>
        </div>

        <div className="transform scale-[0.45] sm:scale-[0.55] lg:scale-[0.75] xl:scale-100 transition-all duration-700">
          {renderSpread(currentIndex)}
        </div>
      </main>

      {/* Print View */}
      <div className="print-only">
        {renderSpread(-1)}
        {pages.map((_, i) => <div key={i}>{renderSpread(i)}</div>)}
        {renderSpread(-2)}
      </div>
    </div>
  );
};

const root = createRoot(document.getElementById('root')!);
root.render(<App />);
