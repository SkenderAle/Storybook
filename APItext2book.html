
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoryVisualizer AI - Dall'Idea al Libro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/opendyslexic@2/opendyslexic.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Andika&family=Amatic+SC:wght@700&family=Playfair+Display:ital,wght@0,700;1,700&display=swap" rel="stylesheet">
    
    <style>
        .font-opendyslexic { font-family: 'OpenDyslexic', sans-serif; }
        .font-patrick { font-family: 'Patrick Hand', cursive; }
        .font-andika { font-family: 'Andika', sans-serif; }
        .font-amatic { font-family: 'Amatic SC', cursive; }
        .font-playfair { font-family: 'Playfair Display', serif; }
        
        body { background-color: #f8fafc; color: #0f172a; margin: 0; font-family: 'Andika', sans-serif; }

        .book-spread {
            filter: drop-shadow(0 25px 50px rgba(0, 0, 0, 0.1));
            transition: all 0.5s ease;
            max-height: 80vh;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .book-spine {
            background: linear-gradient(to right, rgba(0,0,0,0.02) 0%, rgba(0,0,0,0.08) 50%, rgba(0,0,0,0.02) 100%);
            width: 30px;
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
            pointer-events: none;
        }

        .loader-shimmer {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .print-only { display: none; }

        @media print {
            @page { size: landscape; margin: 0; }
            html, body { height: auto !important; overflow: visible !important; background: white !important; }
            #root { display: block !important; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .print-page {
                page-break-after: always !important;
                display: flex !important;
                flex-direction: row !important;
                width: 100vw !important;
                height: 100vh !important;
                -webkit-print-color-adjust: exact !important;
            }
            .page-side { width: 50% !important; height: 100% !important; overflow: hidden !important; position: relative !important; flex-shrink: 0 !important; }
        }
    </style>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@19.2.3",
        "react-dom/client": "https://esm.sh/react-dom@19.2.3/client",
        "@google/genai": "https://esm.sh/@google/genai@1.38.0"
      }
    }
    </script>
</head>
<body class="h-screen overflow-hidden">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useRef, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { GoogleGenAI, Type } from "@google/genai";

        const STYLES = [
            { id: 'realistic', label: 'Realistico', icon: 'üì∏', prompt: 'photorealistic, cinematic lighting, 8k, masterpiece' },
            { id: 'watercolor', label: 'Acquerello', icon: 'üíß', prompt: 'soft watercolor painting, storybook style' },
            { id: 'manga', label: 'Manga / Anime', icon: 'üáØüáµ', prompt: 'clean anime style, vibrant' },
            { id: 'comic', label: 'Fumetto Classico', icon: 'üé®', prompt: 'retro comic book style, bold ink' },
            { id: 'pixelart', label: 'Pixel Art', icon: 'üëæ', prompt: '16-bit retro pixel art' },
            { id: 'oilpainting', label: 'Olio su Tela', icon: 'üñºÔ∏è', prompt: 'oil painting, thick brushstrokes' },
            { id: '3drender', label: '3D Render (Pixar)', icon: 'üß∏', prompt: 'pixar animation style 3d render' },
            { id: 'pencil', label: 'Schizzo a Matita', icon: '‚úèÔ∏è', prompt: 'detailed pencil sketch' },
            { id: 'popart', label: 'Pop Art', icon: 'üç≠', prompt: 'bold pop art style' },
            { id: 'fairytale', label: 'Fiabesco / Magico', icon: 'ü¶Ñ', prompt: 'enchanted fairytale illustration' }
        ];

        const App = () => {
            const [pages, setPages] = useState([]);
            const [fullText, setFullText] = useState('');
            const [title, setTitle] = useState('');
            const [author, setAuthor] = useState('');
            const [currentIndex, setCurrentIndex] = useState(0);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [isGeneratingImg, setIsGeneratingImg] = useState(null); 
            const [status, setStatus] = useState('');
            const [quotaError, setQuotaError] = useState(false);
            const [numScenes, setNumScenes] = useState(6);
            
            const [manualKey, setManualKey] = useState(localStorage.getItem('gemini_api_key') || '');
            const [settings, setSettings] = useState({
                fontFamily: 'font-patrick',
                fontSize: 22,
                textColor: '#1e293b'
            });

            const fileInputRef = useRef(null);

            useEffect(() => {
                localStorage.setItem('gemini_api_key', manualKey);
            }, [manualKey]);

            const callWithRetry = async (fn, retries = 3, initialDelay = 12000) => {
                let currentDelay = initialDelay;
                for (let i = 0; i < retries; i++) {
                    try {
                        setQuotaError(false);
                        return await fn();
                    } catch (err) {
                        const msg = err.message || "";
                        console.error(`Tentativo ${i+1} fallito:`, err);
                        
                        // Rilevamento specifico limit: 0
                        if (msg.includes("limit: 0")) {
                            setQuotaError(true);
                            throw new Error("La tua quota per le immagini √® 0. Devi attivare la fatturazione (Billing) su Google Cloud.");
                        }

                        const isRateLimit = msg.includes('429') || msg.toLowerCase().includes('quota') || msg.toLowerCase().includes('resource_exhausted');

                        if (isRateLimit && i < retries - 1) {
                            setStatus(`Limite raggiunto. Attesa di ${currentDelay/1000}s...`);
                            await new Promise(res => setTimeout(res, currentDelay));
                            currentDelay *= 1.5;
                            continue;
                        }
                        throw err;
                    }
                }
            };

            const cleanJsonResponse = (text) => {
                if (!text) return "";
                let cleaned = text.trim();
                if (cleaned.startsWith("```")) {
                    cleaned = cleaned.replace(/^```(?:json)?/, "").replace(/```$/, "");
                }
                return cleaned.trim();
            };

            const analyzeStory = async () => {
                const key = manualKey || process.env.API_KEY;
                if (!key) return alert("Inserisci una API Key.");
                if (!fullText.trim()) return alert("Inserisci il testo della storia.");

                setIsAnalyzing(true);
                setStatus('Analisi con Gemini 3 Flash...');
                try {
                    const ai = new GoogleGenAI({ apiKey: key });
                    const prompt = `Dividi questa storia in esattamente ${numScenes} scene. 
                    Restituisci solo un JSON array di oggetti con campi "displayText" (italiano) e "imagePrompt" (inglese, descrittivo).
                    TITOLO: ${title}
                    TESTO: ${fullText}`;

                    const response = await callWithRetry(() => ai.models.generateContent({
                        model: 'gemini-3-flash-preview',
                        contents: prompt,
                        config: { 
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: Type.ARRAY,
                                items: {
                                    type: Type.OBJECT,
                                    properties: {
                                        displayText: { type: Type.STRING },
                                        imagePrompt: { type: Type.STRING }
                                    },
                                    required: ["displayText", "imagePrompt"]
                                }
                            }
                        }
                    }));

                    const scenes = JSON.parse(cleanJsonResponse(response.text));
                    const newPages = [
                        { id: 'cover', imageUrl: '', text: '', imagePrompt: 'A beautiful book cover for: ' + title, imageScale: 1, styleId: STYLES[0].id },
                        ...scenes.map((s) => ({
                            id: Math.random().toString(36),
                            imageUrl: '',
                            text: s.displayText,
                            imagePrompt: s.imagePrompt,
                            imageScale: 1,
                            styleId: STYLES[0].id
                        }))
                    ];
                    setPages(newPages);
                    setCurrentIndex(0);
                    setStatus('Storyboard pronto!');
                } catch (err) { 
                    setStatus(`Errore: ${err.message}`); 
                } finally { setIsAnalyzing(false); }
            };

            const generateImage = async (pageIndex) => {
                const key = manualKey || process.env.API_KEY;
                if (!key) return alert("API Key mancante.");
                
                const page = pages[pageIndex];
                const pageStyle = STYLES.find(s => s.id === page.styleId) || STYLES[0];
                
                setIsGeneratingImg(page.id);
                setStatus(`Creazione immagine in corso...`);
                try {
                    const ai = new GoogleGenAI({ apiKey: key });
                    const finalPrompt = `${page.imagePrompt}. Style: ${pageStyle.prompt}. High quality illustration.`;
                    
                    const response = await callWithRetry(() => ai.models.generateContent({
                        model: 'gemini-2.5-flash-image',
                        contents: finalPrompt,
                        config: { imageConfig: { aspectRatio: "1:1" } }
                    }));
                    
                    let base64 = "";
                    const parts = response.candidates?.[0]?.content?.parts || [];
                    for (const part of parts) {
                        if (part.inlineData) {
                            base64 = `data:image/png;base64,${part.inlineData.data}`;
                            break;
                        }
                    }

                    if (base64) {
                        updatePageData(pageIndex, 'imageUrl', base64);
                        setStatus('Immagine generata!');
                    } else {
                        throw new Error("Risposta vuota dall'AI.");
                    }
                } catch (err) { 
                    setStatus(`Errore: ${err.message}`); 
                } finally { setIsGeneratingImg(null); }
            };

            const updatePageData = (index, field, value) => {
                setPages(prev => prev.map((p, i) => i === index ? { ...p, [field]: value } : p));
            };

            const PageView = ({ page, index, isPrint = false }) => (
                <div className={`flex w-full bg-white book-spread overflow-hidden relative ${isPrint ? 'print-page shadow-none border-none' : 'aspect-[1.6/1] max-w-5xl rounded-xl border'}`}>
                    <div className="book-spine" />
                    <div className="page-side w-1/2 h-full bg-slate-50 border-r relative flex items-center justify-center p-4 overflow-hidden">
                        {isGeneratingImg === page.id ? (
                            <div className="w-full h-full flex flex-col items-center justify-center space-y-4">
                                <div className="w-16 h-16 loader-shimmer rounded-full" />
                                <span className="text-[9px] font-black text-indigo-500 animate-pulse uppercase tracking-widest text-center">AI sta dipingendo...</span>
                            </div>
                        ) : page.imageUrl ? (
                            <img src={page.imageUrl} style={{ transform: `scale(${page.imageScale || 1})` }} className="max-w-[85%] max-h-[85%] object-contain shadow-2xl rounded transition-all duration-300" alt="Illustrazione" />
                        ) : (
                            <div className="text-7xl opacity-5 grayscale">üìñ</div>
                        )}
                    </div>
                    <div className="page-side w-1/2 h-full bg-white relative flex flex-col items-center justify-center p-12 text-center">
                        {index === 0 ? (
                            <div className="space-y-6">
                                <h1 className="font-playfair text-5xl text-slate-800 leading-tight">{title || "Titolo Libro"}</h1>
                                <p className="font-patrick text-xl text-slate-400 italic">di {author || "Autore"}</p>
                            </div>
                        ) : (
                            <div className={`w-full ${settings.fontFamily} leading-relaxed custom-scrollbar overflow-y-auto max-h-[70%]`} style={{ fontSize: `${settings.fontSize}px`, color: settings.textColor }} contentEditable={!isPrint} suppressContentEditableWarning onBlur={(e) => updatePageData(index, 'text', e.currentTarget.innerText)}>
                                {page.text || "Scrivi qui il testo..."}
                            </div>
                        )}
                        <div className="absolute bottom-6 w-full text-center text-[9px] font-black text-slate-200 tracking-[0.3em] uppercase">
                            {index === 0 ? "COPERTINA" : `PAGINA ${index}`}
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="flex h-screen bg-slate-100 font-andika overflow-hidden">
                    <div className="print-only">{pages.map((p, i) => <PageView key={p.id} page={p} index={i} isPrint={true} />)}</div>

                    {/* SIDEBAR SINISTRA */}
                    <aside className="no-print w-72 bg-white border-r flex flex-col shadow-xl z-50">
                        <div className="p-5 border-b bg-slate-900 text-white">
                            <h2 className="text-xl font-amatic tracking-[0.2em] uppercase">‚ú® StoryVisualizer</h2>
                        </div>
                        <div className="flex-1 overflow-y-auto p-5 space-y-5 custom-scrollbar">
                            <div className="space-y-2">
                                <label className="text-[9px] font-black text-slate-400 uppercase tracking-widest">Chiave API Gemini</label>
                                <input type="password" placeholder="Incolla API Key" className="w-full p-2.5 text-xs border rounded-lg focus:ring-1 ring-indigo-400 outline-none" value={manualKey} onChange={e => setManualKey(e.target.value)} />
                                <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-[8px] text-indigo-500 font-bold hover:underline block">Crea Chiave Gratuita ‚Üí</a>
                            </div>
                            <div className="space-y-2 pt-3 border-t">
                                <label className="text-[9px] font-black text-slate-400 uppercase tracking-widest">Info Libro</label>
                                <input type="text" placeholder="Titolo" className="w-full p-2.5 text-xs border rounded-lg font-bold" value={title} onChange={e => setTitle(e.target.value)} />
                                <input type="text" placeholder="Autore" className="w-full p-2.5 text-xs border rounded-lg" value={author} onChange={e => setAuthor(e.target.value)} />
                            </div>
                            <div className="space-y-2 pt-3 border-t">
                                <label className="text-[9px] font-black text-slate-400 uppercase tracking-widest block mb-1">Il tuo Racconto</label>
                                <textarea className="w-full h-40 p-2.5 text-[11px] border rounded-lg resize-none outline-none focus:ring-1 ring-slate-300 leading-relaxed" placeholder="Incolla qui la storia..." value={fullText} onChange={e => setFullText(e.target.value)} />
                                <div className="flex justify-between items-center text-[9px] font-bold text-slate-400">
                                    <span>Pagine: {numScenes}</span>
                                    <input type="range" min="3" max="10" value={numScenes} onChange={e => setNumScenes(parseInt(e.target.value))} className="w-24 accent-slate-900" />
                                </div>
                                <button onClick={analyzeStory} disabled={isAnalyzing || !fullText.trim()} className="w-full py-3.5 bg-slate-900 text-white rounded-lg font-bold text-[9px] uppercase tracking-widest shadow-lg hover:bg-black transition-all active:scale-95 disabled:opacity-50">
                                    {isAnalyzing ? 'Elaborazione...' : 'üß† Crea Storyboard'}
                                </button>
                            </div>
                        </div>
                    </aside>

                    {/* AREA CENTRALE */}
                    <main className="no-print flex-1 flex flex-col items-center justify-center p-10 bg-slate-50 relative overflow-hidden">
                        <div className="absolute top-8 flex items-center gap-4 z-40">
                            <button onClick={() => setCurrentIndex(Math.max(0, currentIndex - 1))} className="bg-white p-3 rounded-full shadow hover:scale-110 active:scale-95 transition-all disabled:opacity-30 border" disabled={currentIndex === 0}>‚ùÆ</button>
                            <span className="bg-white px-8 py-2.5 rounded-full text-[10px] font-black text-slate-500 uppercase tracking-widest border shadow-sm">
                                {pages.length > 0 ? (currentIndex === 0 ? 'COPERTINA' : `SCENA ${currentIndex}`) : 'BENVENUTO'}
                            </span>
                            <button onClick={() => setCurrentIndex(Math.min(pages.length - 1, currentIndex + 1))} className="bg-white p-3 rounded-full shadow hover:scale-110 active:scale-95 transition-all disabled:opacity-30 border" disabled={currentIndex === pages.length - 1}>‚ùØ</button>
                        </div>
                        
                        {pages.length > 0 ? (
                            <PageView page={pages[currentIndex]} index={currentIndex} />
                        ) : (
                            <div className="text-center opacity-5 select-none flex flex-col items-center">
                                <span className="text-[12rem]">üìñ</span>
                                <p className="text-xl font-black uppercase tracking-widest mt-2">Pronto per iniziare</p>
                            </div>
                        )}

                        {status && (
                            <div className="absolute bottom-10 px-6 py-3 bg-slate-900 text-white rounded-xl shadow-2xl text-[9px] font-black uppercase tracking-widest z-50 text-center max-w-xl animate-in slide-in-from-bottom duration-300">
                                {status}
                                {quotaError && (
                                    <div className="mt-2 p-2 bg-red-500/20 border border-red-500/50 rounded text-red-200 normal-case font-medium">
                                        ‚ö†Ô∏è Errore Quota: Google ha bloccato la generazione immagini (Limit 0). 
                                        Devi collegare una carta nel piano Pay-as-you-go per sbloccare i modelli Vision.
                                        <a href="https://ai.google.dev/gemini-api/docs/billing" target="_blank" className="underline ml-1 text-white">Documentazione Billing ‚Üí</a>
                                    </div>
                                )}
                            </div>
                        )}
                    </main>

                    {/* SIDEBAR DESTRA */}
                    <aside className="no-print w-72 bg-white border-l flex flex-col shadow-xl z-50">
                        <div className="p-5 border-b">
                            <h3 className="text-[9px] font-black text-slate-400 uppercase tracking-widest">Editor Scena</h3>
                        </div>
                        
                        {pages.length > 0 ? (
                            <div className="flex-1 overflow-y-auto p-5 space-y-6 custom-scrollbar">
                                <div className="space-y-3">
                                    <label className="text-[9px] font-black text-slate-800 uppercase tracking-widest block">üé® Stile</label>
                                    <select className="w-full p-3 text-[11px] border rounded-lg bg-slate-50 font-bold outline-none" value={pages[currentIndex].styleId} onChange={e => updatePageData(currentIndex, 'styleId', e.target.value)}>
                                        {STYLES.map(style => <option key={style.id} value={style.id}>{style.icon} {style.label}</option>)}
                                    </select>
                                    <button onClick={() => generateImage(currentIndex)} disabled={isGeneratingImg === pages[currentIndex].id} className="w-full py-4 bg-indigo-600 text-white rounded-lg font-bold text-[9px] shadow-lg hover:bg-indigo-700 transition-all uppercase tracking-widest active:scale-95 disabled:opacity-50">
                                        ‚ú® Dipingi con AI
                                    </button>
                                </div>
                                <div className="space-y-3 pt-5 border-t">
                                    <label className="text-[9px] font-black text-slate-800 uppercase tracking-widest block">üìù Descrizione Visiva (Prompt)</label>
                                    <textarea className="w-full h-32 p-3 text-[10px] bg-slate-50 border rounded-lg resize-none outline-none leading-relaxed font-medium" value={pages[currentIndex].imagePrompt} onChange={e => updatePageData(currentIndex, 'imagePrompt', e.target.value)} />
                                </div>
                                <div className="space-y-3 pt-5 border-t">
                                    <label className="text-[9px] font-black text-slate-800 uppercase tracking-widest block">üñãÔ∏è Tipografia</label>
                                    <select className="w-full p-2.5 text-[10px] border rounded-lg outline-none font-bold" value={settings.fontFamily} onChange={e => setSettings({...settings, fontFamily: e.target.value})}>
                                        <option value="font-patrick">A Mano</option>
                                        <option value="font-andika">Standard</option>
                                        <option value="font-opendyslexic">Accessibile</option>
                                    </select>
                                    <div className="flex justify-between items-center px-1">
                                        <span className="text-[8px] font-black text-slate-400 uppercase tracking-widest">Dimensione</span>
                                        <span className="text-[10px] font-bold text-indigo-600">{settings.fontSize}px</span>
                                    </div>
                                    <input type="range" min="14" max="48" value={settings.fontSize} onChange={e => setSettings({...settings, fontSize: parseInt(e.target.value)})} className="w-full accent-indigo-600" />
                                </div>
                            </div>
                        ) : (
                            <div className="flex-1 flex flex-col items-center justify-center p-8 opacity-20 italic text-center text-xs">
                                <p>Crea lo storyboard per sbloccare l'arte.</p>
                            </div>
                        )}
                        <div className="p-5 border-t bg-slate-50/50">
                            <button onClick={() => window.print()} disabled={pages.length === 0} className="w-full py-4 bg-slate-900 text-white rounded-lg text-[9px] font-black uppercase tracking-widest shadow-xl">üñ®Ô∏è Stampa / PDF</button>
                        </div>
                    </aside>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
