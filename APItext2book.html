
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoryVisualizer AI - Dall'Idea al Libro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/opendyslexic@2/opendyslexic.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Andika&family=Amatic+SC:wght@700&family=Playfair+Display:ital,wght@0,700;1,700&display=swap" rel="stylesheet">
    
    <style>
        .font-opendyslexic { font-family: 'OpenDyslexic', sans-serif; }
        .font-patrick { font-family: 'Patrick Hand', cursive; }
        .font-andika { font-family: 'Andika', sans-serif; }
        .font-amatic { font-family: 'Amatic SC', cursive; }
        .font-playfair { font-family: 'Playfair Display', serif; }
        
        body { background-color: #f8fafc; color: #0f172a; margin: 0; font-family: 'Andika', sans-serif; }

        .book-spread {
            filter: drop-shadow(0 25px 50px rgba(0, 0, 0, 0.1));
            transition: all 0.5s ease;
            max-height: 80vh;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .book-spine {
            background: linear-gradient(to right, rgba(0,0,0,0.02) 0%, rgba(0,0,0,0.08) 50%, rgba(0,0,0,0.02) 100%);
            width: 30px;
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
            pointer-events: none;
        }

        .loader-shimmer {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .print-only { display: none; }

        @media print {
            @page { size: landscape; margin: 0; }
            html, body { height: auto !important; overflow: visible !important; background: white !important; }
            #root { display: block !important; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .print-page {
                page-break-after: always !important;
                display: flex !important;
                flex-direction: row !important;
                width: 100vw !important;
                height: 100vh !important;
                -webkit-print-color-adjust: exact !important;
            }
            .page-side { width: 50% !important; height: 100% !important; overflow: hidden !important; position: relative !important; flex-shrink: 0 !important; }
        }
    </style>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@19.2.3",
        "react-dom/client": "https://esm.sh/react-dom@19.2.3/client",
        "@google/genai": "https://esm.sh/@google/genai@1.38.0"
      }
    }
    </script>
</head>
<body class="h-screen overflow-hidden">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useRef, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { GoogleGenAI, Type } from "@google/genai";

        const STYLES = [
            { id: 'realistic', label: 'üì∏ Realistico', prompt: 'photorealistic, highly detailed, 8k resolution, cinematic lighting, natural textures' },
            { id: 'futuristic', label: 'üöÄ Futuristico / Cyberpunk', prompt: 'cyberpunk aesthetic, high-tech, neon lights, futuristic city, digital synthwave atmosphere' },
            { id: 'manga', label: 'üáØüáµ Manga / Anime', prompt: 'manga style, cel shaded, anime aesthetic, clean lines, expressive eyes' },
            { id: 'comic', label: 'üé® Fumetto Classico', prompt: 'comic book style, vibrant colors, ink outlines, dynamic shading, graphic novel' },
            { id: 'pixelart', label: 'üëæ Pixel Art', prompt: '16-bit pixel art style, retro video game aesthetic, vibrant sprites' },
            { id: 'oilpainting', label: 'üñºÔ∏è Olio su Tela', prompt: 'classical oil painting, visible brushstrokes, rich textures, canvas background' },
            { id: 'watercolor', label: 'üíß Acquerello', prompt: 'soft watercolor painting, bleeding colors, paper texture, delicate brushstrokes' },
            { id: '3drender', label: 'üß∏ 3D Render (Pixar)', prompt: 'modern 3D animation style, soft lighting, plastic textures, cute character design' },
            { id: 'pencil', label: '‚úèÔ∏è Schizzo a Matita', prompt: 'graphite pencil sketch, cross-hatching, hand-drawn on textured paper' },
            { id: 'steampunk', label: '‚öôÔ∏è Steampunk', prompt: 'steampunk aesthetic, gears and brass, Victorian tech, sepia tones' },
            { id: 'popart', label: 'üç≠ Pop Art', prompt: 'Andy Warhol style, bold colors, Ben-Day dots, high contrast' },
            { id: 'darkfantasy', label: 'üè∞ Dark Fantasy / Gotico', prompt: 'dark gothic atmosphere, moody lighting, intricate medieval details, eerie' },
            { id: 'origami', label: 'üìÑ Origami / Papercraft', prompt: 'papercraft style, folded paper textures, sharp edges, studio lighting' },
            { id: 'stainedglass', label: 'üïØÔ∏è Vetro Colorato', prompt: 'stained glass window style, vibrant backlit colors, black lead outlines' }
        ];

        const App = () => {
            const [pages, setPages] = useState([]);
            const [fullText, setFullText] = useState('');
            const [title, setTitle] = useState('');
            const [author, setAuthor] = useState('');
            const [currentIndex, setCurrentIndex] = useState(0);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [isGeneratingImg, setIsGeneratingImg] = useState(null); 
            const [status, setStatus] = useState('');
            const [numScenes, setNumScenes] = useState(6);
            
            const [manualKey, setManualKey] = useState(localStorage.getItem('gemini_api_key') || '');
            const [settings, setSettings] = useState({
                fontFamily: 'font-patrick',
                fontSize: 22,
                textColor: '#1e293b'
            });

            const fileInputRef = useRef(null);

            useEffect(() => {
                localStorage.setItem('gemini_api_key', manualKey);
            }, [manualKey]);

            const exportProject = () => {
                const projectData = {
                    title, author, fullText, pages, settings, numScenes
                };
                const blob = new Blob([JSON.stringify(projectData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const safeTitle = title.replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'progetto_libro';
                a.download = `${safeTitle}.json`;
                a.click();
                URL.revokeObjectURL(url);
                setStatus('Progetto esportato!');
            };

            const importProject = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        setTitle(data.title || '');
                        setAuthor(data.author || '');
                        setFullText(data.fullText || '');
                        setPages(data.pages || []);
                        setSettings(data.settings || settings);
                        setNumScenes(data.numScenes || 6);
                        setCurrentIndex(0);
                        setStatus('Progetto caricato!');
                    } catch (err) { alert("Errore file JSON."); }
                    e.target.value = '';
                };
                reader.readAsText(file);
            };

            const analyzeStory = async () => {
                const key = manualKey || process.env.API_KEY;
                if (!key) return alert("Inserisci l'API Key.");
                if (!fullText) return alert("Inserisci il testo.");

                setIsAnalyzing(true);
                setStatus('Analisi della storia...');
                try {
                    const ai = new GoogleGenAI({ apiKey: key });
                    const systemPrompt = `Sei un editor. Dividi il testo in esattamente ${numScenes} scene.
                    Restituisci JSON: [{"displayText": "testo breve per bambini", "imagePrompt": "descrizione visiva dettagliata"}]`;

                    const response = await ai.models.generateContent({
                        model: 'gemini-3-pro-preview',
                        contents: [{ parts: [{ text: `${systemPrompt}\n\nTESTO:\n${fullText}` }] }],
                        config: { 
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: Type.ARRAY,
                                items: {
                                    type: Type.OBJECT,
                                    properties: {
                                        displayText: { type: Type.STRING },
                                        imagePrompt: { type: Type.STRING }
                                    }
                                }
                            }
                        }
                    });

                    const scenes = JSON.parse(response.text);
                    const newPages = [
                        { 
                            id: 'cover', 
                            imageUrl: '', 
                            text: '', 
                            imagePrompt: 'Book cover illustration about: ' + title, 
                            imageScale: 1,
                            styleId: STYLES[0].id 
                        },
                        ...scenes.map((s) => ({
                            id: Math.random().toString(36),
                            imageUrl: '',
                            text: s.displayText,
                            imagePrompt: s.imagePrompt,
                            imageScale: 1,
                            styleId: STYLES[0].id
                        }))
                    ];
                    setPages(newPages);
                    setCurrentIndex(0);
                    setStatus('Analisi completata!');
                } catch (err) { setStatus('Errore analisi.'); } finally { setIsAnalyzing(false); }
            };

            const generateImage = async (pageIndex) => {
                const key = manualKey || process.env.API_KEY;
                if (!key) return alert("Inserisci l'API Key.");
                const page = pages[pageIndex];
                const pageStyle = STYLES.find(s => s.id === page.styleId) || STYLES[0];
                
                setIsGeneratingImg(page.id);
                setStatus(`Pittura scena ${pageIndex}...`);
                try {
                    const ai = new GoogleGenAI({ apiKey: key });
                    const finalPrompt = `${page.imagePrompt}, in style of ${pageStyle.prompt}, high quality.`;
                    const response = await ai.models.generateContent({
                        model: 'gemini-2.5-flash-image',
                        contents: [{ parts: [{ text: finalPrompt }] }],
                        config: { imageConfig: { aspectRatio: "1:1" } }
                    });
                    let base64 = "";
                    for (const part of response.candidates[0].content.parts) {
                        if (part.inlineData) base64 = `data:image/png;base64,${part.inlineData.data}`;
                    }
                    if (base64) {
                        const updated = [...pages];
                        updated[pageIndex].imageUrl = base64;
                        setPages(updated);
                        setStatus('Fatto!');
                    }
                } catch (err) { setStatus('Errore immagine.'); } finally { setIsGeneratingImg(null); }
            };

            const updatePageData = (index, field, value) => {
                const updated = [...pages];
                updated[index][field] = value;
                setPages(updated);
            };

            const updatePageScale = (scale) => {
                const up = [...pages];
                up[currentIndex].imageScale = parseFloat(scale);
                setPages(up);
            };

            const handlePrint = () => { if (pages.length > 0) window.print(); };

            const PageView = ({ page, index, isPrint = false }) => (
                <div className={`flex w-full bg-white book-spread overflow-hidden relative ${isPrint ? 'print-page shadow-none' : 'aspect-[1.6/1] max-w-5xl rounded-xl'}`}>
                    <div className="book-spine" />
                    <div className="page-side w-1/2 h-full bg-slate-50 border-r relative flex items-center justify-center p-4 overflow-hidden">
                        {isGeneratingImg === page.id ? (
                            <div className="w-full h-full flex flex-col items-center justify-center space-y-4">
                                <div className="w-24 h-24 loader-shimmer rounded-full" />
                                <span className="text-[10px] font-bold text-slate-400 animate-pulse uppercase">Dipingendo...</span>
                            </div>
                        ) : page.imageUrl ? (
                            <img src={page.imageUrl} style={{ transform: `scale(${page.imageScale || 1})` }} className="max-w-[90%] max-h-[90%] object-contain shadow-2xl rounded transition-transform" />
                        ) : (
                            <div className="flex flex-col items-center opacity-10"><span className="text-8xl">üñºÔ∏è</span></div>
                        )}
                        <div className="absolute inset-y-0 right-0 w-8 bg-gradient-to-l from-black/[0.02] to-transparent" />
                    </div>
                    <div className="page-side w-1/2 h-full bg-white relative flex flex-col items-center justify-center p-12 text-center">
                        <div className="absolute inset-y-0 left-0 w-8 bg-gradient-to-r from-black/[0.02] to-transparent" />
                        {index === 0 ? (
                            <div className="space-y-6">
                                <h1 className="font-playfair text-6xl text-slate-800 leading-tight">{title || "Titolo"}</h1>
                                <p className="font-patrick text-2xl text-slate-400 italic">di {author || "Autore"}</p>
                            </div>
                        ) : (
                            <div className={`w-full ${settings.fontFamily}`} style={{ fontSize: `${settings.fontSize}px`, color: settings.textColor }} contentEditable={!isPrint} suppressContentEditableWarning onBlur={(e) => updatePageData(index, 'text', e.currentTarget.innerText)}>
                                {page.text || (isPrint ? "" : "Testo qui...")}
                            </div>
                        )}
                        <div className="absolute bottom-6 w-full text-center text-[10px] font-black text-slate-200 tracking-[0.5em]">
                            {index === 0 ? "COPERTINA" : `PAGINA ${index}`}
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="flex h-screen bg-slate-100">
                    <div className="print-only">{pages.map((p, i) => <PageView key={p.id} page={p} index={i} isPrint={true} />)}</div>

                    {/* SIDEBAR SINISTRA: SETUP E PROGETTO */}
                    <aside className="no-print w-80 bg-white border-r flex flex-col shadow-2xl z-50">
                        <div className="p-6 border-b bg-slate-900 text-white">
                            <h2 className="text-2xl font-amatic tracking-widest uppercase">‚ú® StoryVisualizer</h2>
                        </div>
                        <div className="flex-1 overflow-y-auto p-6 space-y-6 custom-scrollbar">
                            <div className="space-y-4">
                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Configurazione</label>
                                <input type="password" placeholder="Gemini API Key" className="w-full p-2 text-xs border rounded-lg outline-none" value={manualKey} onChange={e => setManualKey(e.target.value)} />
                                <input type="text" placeholder="Titolo" className="w-full p-2 text-sm border rounded-lg font-bold" value={title} onChange={e => setTitle(e.target.value)} />
                                <input type="text" placeholder="Autore" className="w-full p-2 text-sm border rounded-lg" value={author} onChange={e => setAuthor(e.target.value)} />
                            </div>
                            <div className="space-y-4 pt-4 border-t">
                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">File Progetto</label>
                                <div className="grid grid-cols-2 gap-2">
                                    <button onClick={exportProject} disabled={pages.length === 0} className="py-2 bg-slate-100 text-[10px] font-bold rounded border uppercase">üì§ Salva</button>
                                    <button onClick={() => fileInputRef.current.click()} className="py-2 bg-slate-100 text-[10px] font-bold rounded border uppercase">üì• Apri</button>
                                    <input type="file" ref={fileInputRef} accept=".json" className="hidden" onChange={importProject} />
                                </div>
                            </div>
                            <div className="space-y-4 pt-4 border-t">
                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">Storia Completa</label>
                                <textarea className="w-full h-48 p-3 text-xs border rounded-lg resize-none outline-none focus:ring-1 ring-slate-400" placeholder="Incolla qui la tua storia..." value={fullText} onChange={e => setFullText(e.target.value)} />
                                <div className="flex items-center justify-between">
                                    <span className="text-[10px] font-bold text-slate-400 uppercase">Pagine: {numScenes}</span>
                                    <input type="range" min="3" max="12" value={numScenes} onChange={e => setNumScenes(parseInt(e.target.value))} className="accent-slate-900" />
                                </div>
                                <button onClick={analyzeStory} disabled={isAnalyzing || !fullText} className="w-full py-3 rounded-xl font-bold text-xs text-white bg-slate-900 shadow-lg hover:bg-black transition-all">
                                    {isAnalyzing ? 'ANALISI IN CORSO...' : 'üß† ANALIZZA E DIVIDI IN SCENE'}
                                </button>
                            </div>
                        </div>
                    </aside>

                    {/* MAIN AREA: LIBRO PREVIEW */}
                    <main className="no-print flex-1 flex flex-col items-center justify-center p-12 bg-slate-50 relative">
                        <div className="absolute top-10 flex items-center gap-4 z-40">
                            <button onClick={() => setCurrentIndex(Math.max(0, currentIndex - 1))} className="bg-white p-3 rounded-full shadow hover:scale-110" disabled={currentIndex === 0}>‚ùÆ</button>
                            <span className="bg-white px-6 py-2 rounded-full text-[10px] font-black text-slate-500 uppercase tracking-widest border">
                                {pages.length > 0 ? (currentIndex === 0 ? 'COPERTINA' : `PAGINA ${currentIndex} / ${pages.length - 1}`) : 'INIZIA IL PROGETTO'}
                            </span>
                            <button onClick={() => setCurrentIndex(Math.min(pages.length - 1, currentIndex + 1))} className="bg-white p-3 rounded-full shadow hover:scale-110" disabled={currentIndex === pages.length - 1}>‚ùØ</button>
                        </div>
                        {pages.length > 0 ? (
                            <div className="w-full flex flex-col items-center animate-in zoom-in">
                                <PageView page={pages[currentIndex]} index={currentIndex} />
                            </div>
                        ) : (
                            <div className="text-center opacity-10 select-none"><span className="text-[15rem]">üìñ</span></div>
                        )}
                    </main>

                    {/* SIDEBAR DESTRA: EDITING SCENA E STILE INDIVIDUALE */}
                    <aside className="no-print w-80 bg-white border-l p-6 flex flex-col shadow-2xl z-50">
                        <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-6">Editor della Scena Corrente</h3>
                        
                        {pages.length > 0 ? (
                            <div className="flex-1 space-y-6 overflow-y-auto custom-scrollbar pr-2">
                                {/* SEZIONE STILE SPECIFICO PER PAGINA */}
                                <div className="space-y-4 p-4 bg-indigo-50/50 rounded-xl border border-indigo-100">
                                    <label className="text-[10px] font-black text-indigo-900 uppercase tracking-widest block">üé® Stile di questa Pagina</label>
                                    <select 
                                        className="w-full p-2.5 text-xs border rounded-xl bg-white font-bold outline-none focus:ring-2 ring-indigo-500"
                                        value={pages[currentIndex].styleId || STYLES[0].id}
                                        onChange={e => updatePageData(currentIndex, 'styleId', e.target.value)}
                                    >
                                        {STYLES.map(s => <option key={s.id} value={s.id}>{s.label}</option>)}
                                    </select>
                                    <button 
                                        onClick={() => generateImage(currentIndex)}
                                        disabled={isGeneratingImg === pages[currentIndex].id}
                                        className="w-full py-3.5 bg-indigo-600 text-white rounded-xl font-bold text-[10px] shadow-lg hover:bg-indigo-700 transition-all uppercase tracking-widest disabled:opacity-50"
                                    >
                                        {pages[currentIndex].imageUrl ? 'üîÑ Rigenera Immagine' : '‚ú® Dipingi questa Scena'}
                                    </button>
                                </div>

                                <div className="space-y-2 pt-4 border-t">
                                    <label className="text-[9px] font-black text-slate-400 uppercase tracking-widest">Prompt Visivo (Editabile)</label>
                                    <textarea 
                                        className="w-full h-32 p-3 text-[11px] bg-slate-50 border rounded-lg resize-none outline-none focus:ring-1 ring-indigo-400 leading-relaxed" 
                                        value={pages[currentIndex].imagePrompt} 
                                        onChange={e => updatePageData(currentIndex, 'imagePrompt', e.target.value)} 
                                    />
                                    <p className="text-[8px] text-slate-400 italic">Personalizza la descrizione prima di generare l'immagine.</p>
                                </div>

                                <div className="space-y-2">
                                    <div className="flex justify-between items-center text-[9px] font-black text-slate-400 uppercase">
                                        <span>Zoom Immagine</span>
                                        <span className="text-indigo-600 font-bold">{Math.round((pages[currentIndex].imageScale || 1) * 100)}%</span>
                                    </div>
                                    <input type="range" min="0.5" max="2" step="0.1" value={pages[currentIndex].imageScale || 1} onChange={e => updatePageScale(e.target.value)} className="w-full accent-indigo-600" />
                                </div>

                                <div className="space-y-4 pt-4 border-t">
                                    <label className="text-[9px] font-black text-slate-400 uppercase">Testo del Libro</label>
                                    <select className="w-full p-2 text-xs border rounded-xl outline-none" value={settings.fontFamily} onChange={e => setSettings({...settings, fontFamily: e.target.value})}>
                                        <option value="font-patrick">Handwriting (Scrittura a mano)</option>
                                        <option value="font-andika">Modern Sans (Pulito)</option>
                                        <option value="font-opendyslexic">Accessibile (Alta leggibilit√†)</option>
                                    </select>
                                    <input type="range" min="16" max="44" value={settings.fontSize} onChange={e => setSettings({...settings, fontSize: parseInt(e.target.value)})} className="w-full accent-indigo-600" />
                                </div>
                            </div>
                        ) : (
                            <div className="flex-1 flex items-center justify-center text-[10px] text-slate-300 font-bold uppercase text-center italic">Analizza la storia per attivare l'editor individuale</div>
                        )}

                        <div className="pt-6 border-t mt-auto">
                            <button onClick={handlePrint} disabled={pages.length === 0} className="w-full py-4 bg-slate-900 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-xl hover:bg-black active:scale-95 disabled:opacity-30">üñ®Ô∏è STAMPA / SALVA IN PDF</button>
                        </div>
                    </aside>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
