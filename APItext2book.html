
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoryVisualizer AI - Dall'Idea al Libro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/opendyslexic@2/opendyslexic.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Andika&family=Amatic+SC:wght@700&family=Playfair+Display:ital,wght@0,700;1,700&display=swap" rel="stylesheet">
    
    <style>
        .font-opendyslexic { font-family: 'OpenDyslexic', sans-serif; }
        .font-patrick { font-family: 'Patrick Hand', cursive; }
        .font-andika { font-family: 'Andika', sans-serif; }
        .font-amatic { font-family: 'Amatic SC', cursive; }
        .font-playfair { font-family: 'Playfair Display', serif; }
        
        body { background-color: #f8fafc; color: #0f172a; margin: 0; font-family: 'Andika', sans-serif; }

        .book-spread {
            filter: drop-shadow(0 25px 50px rgba(0, 0, 0, 0.1));
            transition: all 0.5s ease;
            max-height: 80vh;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .book-spine {
            background: linear-gradient(to right, rgba(0,0,0,0.02) 0%, rgba(0,0,0,0.08) 50%, rgba(0,0,0,0.02) 100%);
            width: 30px;
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
            pointer-events: none;
        }

        .loader-shimmer {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .print-only { display: none; }

        @media print {
            @page { size: landscape; margin: 0; }
            html, body { height: auto !important; overflow: visible !important; background: white !important; }
            #root { display: block !important; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .print-page {
                page-break-after: always !important;
                display: flex !important;
                flex-direction: row !important;
                width: 100vw !important;
                height: 100vh !important;
                -webkit-print-color-adjust: exact !important;
            }
            .page-side { width: 50% !important; height: 100% !important; overflow: hidden !important; position: relative !important; flex-shrink: 0 !important; }
        }
    </style>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@19.2.3",
        "react-dom/client": "https://esm.sh/react-dom@19.2.3/client",
        "@google/genai": "https://esm.sh/@google/genai@1.38.0"
      }
    }
    </script>
</head>
<body class="h-screen overflow-hidden">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useRef, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { GoogleGenAI, Type } from "@google/genai";

        const STYLES = [
            { id: 'watercolor', label: 'Acquerello', icon: 'üíß', prompt: 'soft watercolor painting, storybook style' },
            { id: 'manga', label: 'Manga / Anime', icon: 'üáØüáµ', prompt: 'clean anime style, vibrant' },
            { id: 'comic', label: 'Fumetto Classico', icon: 'üé®', prompt: 'retro comic book style, bold ink' },
            { id: 'fairytale', label: 'Fiabesco', icon: 'ü¶Ñ', prompt: 'enchanted fairytale illustration' },
            { id: 'oilpainting', label: 'Olio su Tela', icon: 'üñºÔ∏è', prompt: 'oil painting style' },
            { id: '3drender', label: '3D Render', icon: 'üß∏', prompt: 'pixar animation style 3d render' }
        ];

        const App = () => {
            const [pages, setPages] = useState([]);
            const [fullText, setFullText] = useState('');
            const [title, setTitle] = useState('');
            const [author, setAuthor] = useState('');
            const [currentIndex, setCurrentIndex] = useState(0);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [isGeneratingImg, setIsGeneratingImg] = useState(null); 
            const [status, setStatus] = useState('');
            const [numScenes, setNumScenes] = useState(6);
            const [hasKey, setHasKey] = useState(false);
            
            const [settings, setSettings] = useState({
                fontFamily: 'font-patrick',
                fontSize: 22,
                textColor: '#1e293b'
            });

            const fileInputRef = useRef(null);

            useEffect(() => {
                const checkKeyStatus = async () => {
                    if (window.aistudio && typeof window.aistudio.hasSelectedApiKey === 'function') {
                        const selected = await window.aistudio.hasSelectedApiKey();
                        setHasKey(selected);
                    }
                };
                checkKeyStatus();
            }, []);

            const handleSelectKey = async () => {
                if (window.aistudio && typeof window.aistudio.openSelectKey === 'function') {
                    try {
                        await window.aistudio.openSelectKey();
                        setHasKey(true);
                        setStatus("Chiave configurata con successo!");
                    } catch (e) {
                        setStatus("Impossibile aprire la selezione chiave.");
                    }
                } else {
                    alert("Funzione di selezione chiave disponibile solo nell'ambiente AI Studio.");
                }
            };

            const analyzeStory = async () => {
                setIsAnalyzing(true);
                setStatus('Analisi racconto in corso...');
                try {
                    const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
                    const response = await ai.models.generateContent({
                        model: 'gemini-3-flash-preview',
                        contents: `Dividi questa storia in ${numScenes} scene. 
                        Restituisci solo JSON: [{"displayText": "testo", "imagePrompt": "descrizione visiva inglese"}]
                        TITOLO: ${title}
                        TESTO: ${fullText}`,
                        config: { 
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: Type.ARRAY,
                                items: {
                                    type: Type.OBJECT,
                                    properties: {
                                        displayText: { type: Type.STRING },
                                        imagePrompt: { type: Type.STRING }
                                    },
                                    required: ["displayText", "imagePrompt"]
                                }
                            }
                        }
                    });

                    const scenes = JSON.parse(response.text);

                    setPages([
                        { id: 'cover', imageUrl: '', text: '', imagePrompt: 'Splendid book cover for: ' + title, imageScale: 1, styleId: STYLES[0].id },
                        ...scenes.map((s) => ({
                            id: Math.random().toString(36),
                            imageUrl: '',
                            text: s.displayText,
                            imagePrompt: s.imagePrompt,
                            imageScale: 1,
                            styleId: STYLES[0].id
                        }))
                    ]);
                    setCurrentIndex(0);
                    setStatus('Storyboard completato!');
                } catch (err) { 
                    handleApiError(err, "Analisi");
                } finally { setIsAnalyzing(false); }
            };

            const generateImage = async (pageIndex) => {
                const page = pages[pageIndex];
                const pageStyle = STYLES.find(s => s.id === page.styleId) || STYLES[0];
                
                setIsGeneratingImg(page.id);
                setStatus(`Generazione immagine...`);
                try {
                    const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
                    const response = await ai.models.generateContent({
                        model: 'gemini-3-pro-image-preview',
                        contents: {
                            parts: [{ text: `${page.imagePrompt}. Style: ${pageStyle.prompt}. High quality illustration for kids book.` }]
                        },
                        config: { 
                            imageConfig: { aspectRatio: "1:1", imageSize: "1K" }
                        }
                    });
                    
                    let base64 = "";
                    const candidates = response.candidates || [];
                    if (candidates.length > 0 && candidates[0].content && candidates[0].content.parts) {
                        for (const part of candidates[0].content.parts) {
                            if (part.inlineData) {
                                base64 = `data:image/png;base64,${part.inlineData.data}`;
                                break;
                            }
                        }
                    }

                    if (base64) {
                        updatePageData(pageIndex, 'imageUrl', base64);
                        setStatus('Immagine creata!');
                    } else {
                        throw new Error("L'AI non ha prodotto dati immagine. Verifica i tuoi crediti e permessi.");
                    }
                } catch (err) { 
                    handleApiError(err, "Immagine");
                } finally { setIsGeneratingImg(null); }
            };

            const handleApiError = (err, context) => {
                console.error(err);
                const msg = err.message || "";
                if (msg.includes("Requested entity was not found") || msg.includes("API key not valid")) {
                    setHasKey(false);
                    setStatus("Errore: Chiave API non valida. Seleziona un progetto con billing attivo.");
                    handleSelectKey();
                } else {
                    setStatus(`Errore ${context}: ${msg}`);
                }
            };

            const exportToJson = () => {
                const data = { title, author, fullText, numScenes, settings, pages };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                const safeTitle = (title || 'mio-libro').replace(/[^a-z0-9]/gi, '_').toLowerCase();
                link.download = `${safeTitle}.json`;
                link.click();
                setStatus('Progetto esportato correttamente!');
            };

            const importFromJson = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        setTitle(data.title || '');
                        setAuthor(data.author || '');
                        setFullText(data.fullText || '');
                        setNumScenes(data.numScenes || 6);
                        setSettings(data.settings || settings);
                        setPages(data.pages || []);
                        setCurrentIndex(0);
                        setStatus('Progetto caricato!');
                    } catch (err) { alert("Errore nel caricamento del file JSON."); }
                };
                reader.readAsText(file);
                event.target.value = ""; // Reset per permettere ricaricamento stesso file
            };

            const updatePageData = (index, field, value) => {
                setPages(prev => prev.map((p, i) => i === index ? { ...p, [field]: value } : p));
            };

            const PageView = ({ page, index, isPrint = false }) => (
                <div className={`flex w-full bg-white book-spread overflow-hidden relative ${isPrint ? 'print-page shadow-none border-none' : 'aspect-[1.6/1] max-w-5xl rounded-xl border shadow-2xl'}`}>
                    <div className="book-spine" />
                    <div className="page-side w-1/2 h-full bg-slate-50 border-r relative flex items-center justify-center p-4">
                        {isGeneratingImg === page.id ? (
                            <div className="w-full h-full flex flex-col items-center justify-center space-y-4">
                                <div className="w-12 h-12 loader-shimmer rounded-full" />
                                <span className="text-[10px] font-black text-indigo-500 animate-pulse uppercase tracking-widest">Dipingendo...</span>
                            </div>
                        ) : page.imageUrl ? (
                            <img src={page.imageUrl} className="max-w-[85%] max-h-[85%] object-contain shadow-2xl rounded" alt="Pagina" />
                        ) : (
                            <div className="text-8xl opacity-5">üé®</div>
                        )}
                    </div>
                    <div className="page-side w-1/2 h-full bg-white relative flex flex-col items-center justify-center p-12 text-center">
                        {index === 0 ? (
                            <div className="space-y-6">
                                <h1 className="font-playfair text-5xl text-slate-800 leading-tight">{title || "Il Tuo Libro"}</h1>
                                <p className="font-patrick text-xl text-slate-400 italic">di {author || "Scrittore"}</p>
                            </div>
                        ) : (
                            <div className={`w-full ${settings.fontFamily} leading-relaxed custom-scrollbar overflow-y-auto max-h-[70%]`} style={{ fontSize: `${settings.fontSize}px`, color: settings.textColor }} contentEditable={!isPrint} suppressContentEditableWarning onBlur={(e) => updatePageData(index, 'text', e.currentTarget.innerText)}>
                                {page.text || "Scrivi il testo qui..."}
                            </div>
                        )}
                        <div className="absolute bottom-6 w-full text-center text-[9px] font-black text-slate-200 uppercase tracking-widest">
                            {index === 0 ? "COPERTINA" : `SCENA ${index}`}
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="flex h-screen bg-slate-100 font-andika overflow-hidden">
                    <div className="print-only">{pages.map((p, i) => <PageView key={p.id} page={p} index={i} isPrint={true} />)}</div>

                    {/* SIDEBAR SINISTRA */}
                    <aside className="no-print w-72 bg-white border-r flex flex-col shadow-xl z-50">
                        <div className="p-5 border-b bg-slate-900 text-white">
                            <h2 className="text-xl font-amatic uppercase tracking-widest">‚ú® StoryVisualizer</h2>
                        </div>
                        <div className="flex-1 overflow-y-auto p-5 space-y-5 custom-scrollbar">
                            
                            {/* AZIONI FILE */}
                            <div className="grid grid-cols-2 gap-2 mb-4">
                                <button onClick={exportToJson} className="flex flex-col items-center justify-center p-3 bg-slate-100 hover:bg-slate-200 rounded-lg text-[9px] font-black uppercase tracking-tighter transition-all">
                                    <span className="text-xl mb-1">üíæ</span> Esporta
                                </button>
                                <button onClick={() => fileInputRef.current.click()} className="flex flex-col items-center justify-center p-3 bg-slate-100 hover:bg-slate-200 rounded-lg text-[9px] font-black uppercase tracking-tighter transition-all">
                                    <span className="text-xl mb-1">üìÇ</span> Importa
                                </button>
                                <input type="file" ref={fileInputRef} onChange={importFromJson} className="hidden" accept=".json" />
                            </div>

                            {/* API KEY CONFIG (BYOK) */}
                            <div className="p-4 bg-indigo-50 rounded-lg border border-indigo-100 space-y-3">
                                <label className="text-[9px] font-black text-indigo-400 uppercase tracking-widest flex justify-between items-center">
                                    <span>Stato API</span>
                                    {hasKey ? <span className="text-green-600">CONNESSO ‚úÖ</span> : <span className="text-red-500">DA CONFIGURARE ‚ùå</span>}
                                </label>
                                <button onClick={handleSelectKey} className="w-full py-2.5 bg-indigo-600 text-white rounded-lg text-[10px] font-black uppercase tracking-widest hover:bg-indigo-700 shadow-md transition-all active:scale-95">
                                    üîë Configura API Key
                                </button>
                                <p className="text-[8px] text-indigo-700/70 leading-tight">
                                    Seleziona un progetto con fatturazione attiva.
                                    <a href="https://ai.google.dev/gemini-api/docs/billing" target="_blank" className="underline ml-1 font-bold block mt-1">Documentazione Billing ‚Üí</a>
                                </p>
                            </div>
                            
                            <div className="space-y-2 pt-3 border-t">
                                <label className="text-[9px] font-black text-slate-400 uppercase tracking-widest">Dati Libro</label>
                                <input type="text" placeholder="Titolo del libro" className="w-full p-2.5 text-xs border rounded-lg font-bold outline-none focus:border-slate-400" value={title} onChange={e => setTitle(e.target.value)} />
                                <input type="text" placeholder="Nome Autore" className="w-full p-2.5 text-xs border rounded-lg outline-none focus:border-slate-400" value={author} onChange={e => setAuthor(e.target.value)} />
                            </div>
                            
                            <div className="space-y-2 pt-3 border-t">
                                <label className="text-[9px] font-black text-slate-400 uppercase tracking-widest block mb-1">Storia Completa</label>
                                <textarea className="w-full h-40 p-2.5 text-[11px] border rounded-lg resize-none outline-none focus:ring-1 ring-slate-200" placeholder="Incolla o scrivi qui il racconto..." value={fullText} onChange={e => setFullText(e.target.value)} />
                                <div className="flex justify-between items-center text-[9px] font-bold text-slate-400">
                                    <span>Numero Scene: {numScenes}</span>
                                    <input type="range" min="3" max="20" value={numScenes} onChange={e => setNumScenes(parseInt(e.target.value))} className="w-24 accent-slate-900" />
                                </div>
                                <button onClick={analyzeStory} disabled={isAnalyzing || !fullText.trim() || !hasKey} className="w-full py-4 bg-slate-900 text-white rounded-lg font-bold text-[10px] uppercase tracking-widest hover:bg-black transition-all active:scale-95 disabled:opacity-50 shadow-lg mt-2">
                                    {isAnalyzing ? 'Elaborazione...' : 'üß† Crea Storyboard'}
                                </button>
                            </div>
                        </div>
                    </aside>

                    {/* AREA CENTRALE */}
                    <main className="no-print flex-1 flex flex-col items-center justify-center p-10 bg-slate-50 relative overflow-hidden">
                        <div className="absolute top-8 flex items-center gap-4 z-40">
                            <button onClick={() => setCurrentIndex(Math.max(0, currentIndex - 1))} className="bg-white p-3 rounded-full shadow hover:scale-110 active:scale-95 disabled:opacity-30 border transition-all" disabled={currentIndex === 0}>‚ùÆ</button>
                            <span className="bg-white px-8 py-2.5 rounded-full text-[10px] font-black text-slate-500 uppercase tracking-widest border shadow-sm">
                                {pages.length > 0 ? (currentIndex === 0 ? 'COPERTINA' : `SCENA ${currentIndex} / ${pages.length - 1}`) : 'NUOVO LIBRO'}
                            </span>
                            <button onClick={() => setCurrentIndex(Math.min(pages.length - 1, currentIndex + 1))} className="bg-white p-3 rounded-full shadow hover:scale-110 active:scale-95 disabled:opacity-30 border transition-all" disabled={currentIndex === pages.length - 1}>‚ùØ</button>
                        </div>
                        
                        {pages.length > 0 ? (
                            <PageView page={pages[currentIndex]} index={currentIndex} />
                        ) : (
                            <div className="text-center opacity-5 select-none flex flex-col items-center">
                                <span className="text-[12rem]">üìñ</span>
                                <p className="text-xl font-black uppercase tracking-widest mt-2">Pronto per scrivere</p>
                            </div>
                        )}

                        {status && (
                            <div className="absolute bottom-10 px-6 py-4 bg-slate-900 text-white rounded-xl shadow-2xl text-[10px] font-black uppercase tracking-widest z-50 text-center max-w-2xl border-t-2 border-indigo-500">
                                {status}
                            </div>
                        )}
                    </main>

                    {/* SIDEBAR DESTRA */}
                    <aside className="no-print w-72 bg-white border-l flex flex-col shadow-xl z-50">
                        <div className="p-5 border-b">
                            <h3 className="text-[9px] font-black text-slate-400 uppercase tracking-widest text-center">Strumenti Scena</h3>
                        </div>
                        
                        {pages.length > 0 ? (
                            <div className="flex-1 overflow-y-auto p-5 space-y-6 custom-scrollbar">
                                <div className="space-y-3">
                                    <label className="text-[9px] font-black text-slate-800 uppercase tracking-widest block">üé® Stile Grafico</label>
                                    <select className="w-full p-3 text-[11px] border rounded-lg bg-slate-50 font-bold outline-none cursor-pointer" value={pages[currentIndex].styleId} onChange={e => updatePageData(currentIndex, 'styleId', e.target.value)}>
                                        {STYLES.map(style => <option key={style.id} value={style.id}>{style.icon} {style.label}</option>)}
                                    </select>
                                    <button onClick={() => generateImage(currentIndex)} disabled={isGeneratingImg === pages[currentIndex].id || !hasKey} className="w-full py-4 bg-indigo-600 text-white rounded-lg font-bold text-[10px] shadow-lg hover:bg-indigo-700 transition-all uppercase tracking-widest active:scale-95 disabled:opacity-50">
                                        ‚ú® Genera Illustrazione (Pro)
                                    </button>
                                </div>
                                <div className="space-y-3 pt-5 border-t">
                                    <label className="text-[9px] font-black text-slate-800 uppercase tracking-widest block">üìù Descrizione Scena (AI)</label>
                                    <textarea className="w-full h-32 p-3 text-[10px] bg-slate-50 border rounded-lg resize-none outline-none leading-relaxed font-medium" value={pages[currentIndex].imagePrompt} onChange={e => updatePageData(currentIndex, 'imagePrompt', e.target.value)} />
                                    <p className="text-[8px] text-slate-400 italic">Modifica il testo sopra per cambiare i dettagli del disegno.</p>
                                </div>
                                <div className="space-y-3 pt-5 border-t">
                                    <label className="text-[9px] font-black text-slate-800 uppercase tracking-widest block">üñãÔ∏è Impostazioni Testo</label>
                                    <select className="w-full p-2.5 text-[10px] border rounded-lg outline-none font-bold" value={settings.fontFamily} onChange={e => setSettings({...settings, fontFamily: e.target.value})}>
                                        <option value="font-patrick">Carattere a Mano</option>
                                        <option value="font-andika">Andika (Pulito)</option>
                                        <option value="font-opendyslexic">OpenDyslexic (Leggibilit√†)</option>
                                        <option value="font-playfair">Playfair (Elegante)</option>
                                    </select>
                                    <div className="flex justify-between items-center px-1">
                                        <span className="text-[8px] font-black text-slate-400 uppercase">Dimensione Carattere</span>
                                        <span className="text-[10px] font-bold text-indigo-600">{settings.fontSize}px</span>
                                    </div>
                                    <input type="range" min="14" max="48" value={settings.fontSize} onChange={e => setSettings({...settings, fontSize: parseInt(e.target.value)})} className="w-full accent-indigo-600" />
                                </div>
                            </div>
                        ) : (
                            <div className="flex-1 flex flex-col items-center justify-center p-8 opacity-20 italic text-center text-xs">
                                <p>Crea lo storyboard per iniziare a personalizzare le illustrazioni.</p>
                            </div>
                        )}
                        <div className="p-5 border-t bg-slate-50/50">
                            <button onClick={() => window.print()} disabled={pages.length === 0} className="w-full py-4 bg-slate-900 text-white rounded-lg text-[10px] font-black uppercase tracking-widest shadow-xl hover:bg-black transition-all">üñ®Ô∏è Esporta Libro in PDF</button>
                        </div>
                    </aside>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
