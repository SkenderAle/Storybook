<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StoryVisualizer AI - Progetto Didattico</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Andika&family=Amatic+SC:wght@700&family=Patrick+Hand&family=Playfair+Display:ital,wght@0,700;1,700&display=swap" rel="stylesheet">
  <style>
    .font-patrick { font-family: 'Patrick Hand', cursive; }
    .font-andika { font-family: 'Andika', sans-serif; }
    .font-amatic { font-family: 'Amatic SC', cursive; }
    .font-playfair { font-family: 'Playfair Display', serif; }
    
    @page { size: landscape; margin: 0; }
    
    /* Isolamento totale dell'area stampa dalla visualizzazione web */
    #print-area-root { display: none !important; }

    @media print {
      .no-print { display: none !important; }
      #print-area-root { display: block !important; }
      .page-break { 
        page-break-after: always; 
        overflow: hidden; 
        height: 100vh; 
        width: 100vw; 
        display: flex !important; 
        flex-direction: row !important;
        background: white;
      }
      body { background: white !important; overflow: visible !important; }
    }

    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

    .book-spine {
      background: linear-gradient(to right, rgba(0,0,0,0.05) 0%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.05) 100%);
      width: 30px;
      position: absolute;
      top: 0; bottom: 0; left: 50%;
      transform: translateX(-50%);
      z-index: 20;
      pointer-events: none;
    }
    
    .shimmer {
      background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }
    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .page-input-style {
      background: transparent;
      border: none;
      outline: none;
      resize: none;
      width: 100%;
      height: 100%;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
  </style>
  <script type="importmap">
  {
    "imports": {
      "react": "https://esm.sh/react@^19.2.3",
      "react-dom": "https://esm.sh/react-dom@^19.2.3",
      "react-dom/client": "https://esm.sh/react-dom@^19.2.3/client",
      "@google/genai": "https://esm.sh/@google/genai@^1.38.0",
      "htm": "https://esm.sh/htm@3.1.1"
    }
  }
  </script>
</head>
<body class="bg-slate-50 text-slate-900 overflow-hidden">
  <div id="root"></div>

  <script type="module">
    import React, { useState, useEffect, useRef } from 'react';
    import ReactDOM from 'react-dom/client';
    import { GoogleGenAI, Type } from "@google/genai";
    import htm from 'htm';

    const html = htm.bind(React.createElement);

    const STYLES = [
      { id: 'watercolor', label: 'Acquerello', icon: 'üíß', prompt: 'soft watercolor illustration, storybook style' },
      { id: 'manga', label: 'Anime/Manga', icon: 'üáØüáµ', prompt: 'vibrant anime style, clean lines' },
      { id: 'comic', label: 'Fumetto', icon: 'üé®', prompt: 'classic comic book ink style' },
      { id: 'fairytale', label: 'Fiabesco', icon: 'ü¶Ñ', prompt: 'enchanted fairytale painting' },
      { id: '3d', label: 'Pixar Style', icon: 'üß∏', prompt: '3d animation style, high detail' }
    ];

    const FONTS = [
      { value: 'font-patrick', label: 'Manoscritto' },
      { value: 'font-andika', label: 'Andika' },
      { value: 'font-playfair', label: 'Elegante' }
    ];

    const App = () => {
      const [pages, setPages] = useState([]);
      const [title, setTitle] = useState('');
      const [author, setAuthor] = useState('');
      const [fullText, setFullText] = useState('');
      const [numScenes, setNumScenes] = useState(6);
      const [currentIndex, setCurrentIndex] = useState(0);
      const [loading, setLoading] = useState(false);
      const [generatingId, setGeneratingId] = useState(null);
      const [status, setStatus] = useState('');
      const [showKeyModal, setShowKeyModal] = useState(true);
      const [hasKey, setHasKey] = useState(false);
      const [settings, setSettings] = useState({
        fontFamily: 'font-patrick',
        fontSize: 24
      });

      const fileInputRef = useRef(null);

      // Controllo iniziale della chiave
      useEffect(() => {
        const checkKey = async () => {
          try {
            if (window.aistudio && typeof window.aistudio.hasSelectedApiKey === 'function') {
              const ok = await window.aistudio.hasSelectedApiKey();
              setHasKey(ok);
              if (ok) setShowKeyModal(false);
            }
          } catch (e) {
            console.error("Errore nel controllo API Key iniziale:", e);
          }
        };
        checkKey();
      }, []);

      const handleKeySelection = async () => {
        try {
          if (window.aistudio && typeof window.aistudio.openSelectKey === 'function') {
            await window.aistudio.openSelectKey();
            // Assumiamo successo immediato come da istruzioni
            setHasKey(true);
            setShowKeyModal(false);
            setStatus("API Key pronta.");
          } else {
            alert("Il selettore di API Key non √® disponibile in questo ambiente. Assicurati di essere in un'anteprima supportata.");
          }
        } catch (err) {
          console.error("Errore durante l'apertura del selettore:", err);
          setStatus("Errore selettore API.");
        }
      };

      const handleExport = () => {
        const project = { title, author, fullText, pages, settings, numScenes };
        const data = JSON.stringify(project, null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `${title.replace(/\s+/g, '_') || 'Mio_Libro_AI'}.json`;
        link.click();
      };

      const handleImport = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const data = JSON.parse(event.target.result);
            setTitle(data.title || '');
            setAuthor(data.author || '');
            setFullText(data.fullText || '');
            setPages(data.pages || []);
            setSettings(data.settings || settings);
            setCurrentIndex(0);
            setStatus("Progetto caricato!");
          } catch (err) { setStatus("Errore nel file JSON."); }
        };
        reader.readAsText(file);
      };

      const handleAnalyze = async () => {
        if (!fullText.trim()) return;
        setLoading(true);
        setStatus("Divisione in scene...");
        try {
          const ai = new GoogleGenAI({ apiKey: process.env.API_KEY || '' });
          const response = await ai.models.generateContent({
            model: 'gemini-3-flash-preview',
            contents: `Analizza questa storia e dividila in esattamente ${numScenes} scene. Ritorna JSON. TITOLO: ${title}. TESTO: ${fullText}`,
            config: { 
              responseMimeType: "application/json",
              responseSchema: {
                type: Type.ARRAY,
                items: {
                  type: Type.OBJECT,
                  properties: { text: { type: Type.STRING }, imagePrompt: { type: Type.STRING } },
                  required: ["text", "imagePrompt"]
                }
              }
            }
          });
          const scenes = JSON.parse(response.text);
          setPages([
            { id: 'cover', imageUrl: '', text: '', imagePrompt: `Una bellissima copertina per un libro intitolato: ${title}`, styleId: STYLES[0].id },
            ...scenes.map(s => ({ 
              id: Math.random().toString(36).substr(2, 9), 
              imageUrl: '', 
              text: s.text, 
              imagePrompt: s.imagePrompt, 
              styleId: STYLES[0].id 
            }))
          ]);
          setCurrentIndex(0);
          setStatus("Storyboard creato!");
        } catch (err) { 
          setStatus("Errore AI: " + err.message); 
        } finally { setLoading(false); }
      };

      const handleGenerateImage = async (idx) => {
        if (!hasKey) return handleKeySelection();
        setGeneratingId(pages[idx].id);
        setStatus("Generazione illustrazione...");
        
        try {
          const ai = new GoogleGenAI({ apiKey: process.env.API_KEY || '' });
          const style = STYLES.find(s => s.id === pages[idx].styleId) || STYLES[0];
          
          const response = await ai.models.generateContent({
            model: 'gemini-3-pro-image-preview',
            contents: { parts: [{ text: `${style.prompt}: ${pages[idx].imagePrompt}. Storybook style, consistent colors.` }] },
            config: { imageConfig: { aspectRatio: "1:1", imageSize: "1K" } }
          });

          const imgPart = response.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
          if (imgPart) {
            const updated = [...pages];
            updated[idx].imageUrl = `data:image/png;base64,${imgPart.inlineData.data}`;
            setPages(updated);
            setStatus("Immagine pronta!");
          }
        } catch (err) { 
          console.error("Errore generazione immagine:", err);
          if (err.message && err.message.includes("Requested entity was not found")) {
            setStatus("Errore Billing: Seleziona una chiave valida.");
            setHasKey(false);
            setShowKeyModal(true);
          } else {
            setStatus("Errore: " + err.message.substring(0, 30));
          }
        } finally { 
          setGeneratingId(null); 
        }
      };

      const updateText = (idx, newText) => {
        const updated = [...pages];
        updated[idx].text = newText;
        setPages(updated);
      };

      return html`
        <div className="flex h-screen w-full font-andika relative bg-slate-100 overflow-hidden">
          
          <!-- MODALE API KEY OBBLIGATORIA -->
          ${showKeyModal && html`
            <div className="fixed inset-0 z-[100] bg-slate-900/95 flex items-center justify-center p-6 backdrop-blur-md">
              <div className="max-w-md w-full bg-white rounded-3xl p-10 shadow-2xl text-center border-4 border-indigo-100">
                <div className="text-6xl mb-6">üé®</div>
                <h2 className="text-2xl font-black mb-4">Attiva la Generazione AI</h2>
                <p className="text-slate-500 text-sm mb-8 leading-relaxed">
                  Per creare le illustrazioni √® necessario collegare la propria API Key di Google AI Studio. Ogni utente gestisce i propri consumi in autonomia.
                </p>
                <button 
                  onClick=${handleKeySelection} 
                  className="w-full py-4 bg-indigo-600 text-white rounded-xl font-black uppercase tracking-widest hover:scale-105 transition-transform shadow-xl active:bg-indigo-700"
                >
                  Seleziona API Key
                </button>
                <div className="mt-8 pt-6 border-t">
                  <a href="https://ai.google.dev/gemini-api/docs/billing" target="_blank" className="text-[10px] text-indigo-400 font-bold uppercase underline">
                    Guida Billing Google AI Studio
                  </a>
                </div>
              </div>
            </div>
          `}

          <!-- SIDEBAR SINISTRA: INPUT -->
          <aside className="no-print w-80 bg-white border-r shadow-2xl z-50 flex flex-col">
            <div className="p-6 bg-indigo-950 text-white flex justify-between items-center">
              <span className="text-xl font-amatic font-bold tracking-widest uppercase">StoryVisualizer</span>
              <button onClick=${()=>setShowKeyModal(true)} className="text-[10px] bg-white/20 px-2 py-1 rounded hover:bg-white/30">KEY</button>
            </div>
            
            <div className="flex-1 overflow-y-auto p-5 space-y-6 custom-scrollbar">
              <div className="space-y-4">
                <input placeholder="Titolo del libro" value=${title} onChange=${e=>setTitle(e.target.value)} className="w-full p-3 border rounded-xl text-sm font-bold bg-slate-50 outline-none focus:ring-2 ring-indigo-500 transition-all" />
                <input placeholder="Nome dell'autore" value=${author} onChange=${e=>setAuthor(e.target.value)} className="w-full p-3 border rounded-xl text-sm bg-slate-50 outline-none focus:ring-2 ring-indigo-500 transition-all" />
                <textarea placeholder="Inserisci qui il testo della tua storia..." value=${fullText} onChange=${e=>setFullText(e.target.value)} className="w-full h-40 p-4 border rounded-xl text-xs outline-none bg-slate-50 resize-none focus:ring-2 ring-indigo-500" />
                
                <div className="flex justify-between items-center px-2">
                  <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Scene: ${numScenes}</span>
                  <input type="range" min="3" max="15" value=${numScenes} onChange=${e=>setNumScenes(Number(e.target.value))} className="w-24 accent-indigo-600" />
                </div>

                <button onClick=${handleAnalyze} disabled=${loading || !fullText.trim()} className="w-full py-4 bg-indigo-600 text-white rounded-2xl font-black text-xs uppercase shadow-lg hover:bg-indigo-700 disabled:opacity-50 active:scale-95 transition-all">
                  ${loading ? 'Elaborazione...' : '‚ú® Genera Storyboard'}
                </button>
              </div>

              <div className="pt-6 border-t grid grid-cols-2 gap-3">
                <button onClick=${handleExport} className="py-3 bg-slate-50 border rounded-xl text-[10px] font-black uppercase hover:bg-indigo-50 hover:border-indigo-200 transition-colors">Esporta</button>
                <button onClick=${()=>fileInputRef.current.click()} className="py-3 bg-slate-50 border rounded-xl text-[10px] font-black uppercase hover:bg-indigo-50 hover:border-indigo-200 transition-colors">Importa</button>
                <input type="file" ref=${fileInputRef} onChange=${handleImport} className="hidden" accept=".json" />
              </div>
            </div>
          </aside>

          <!-- AREA LIBRO: VISUALIZZAZIONE -->
          <main className="no-print flex-1 flex flex-col items-center justify-center p-8 relative">
            <div className="flex items-center gap-10 mb-10 z-40">
              <button disabled=${currentIndex === 0 || !pages.length} onClick=${()=>setCurrentIndex(currentIndex-1)} className="w-16 h-16 bg-white rounded-full shadow-xl flex items-center justify-center border hover:scale-110 disabled:opacity-20 transition-all text-2xl active:scale-90">‚ùÆ</button>
              <div className="bg-white/90 backdrop-blur-md px-12 py-3 rounded-full border shadow-sm text-xs font-black uppercase tracking-widest text-indigo-900 ring-4 ring-indigo-50">
                ${pages.length ? (currentIndex === 0 ? 'Copertina' : `Pagina ${currentIndex} / ${pages.length-1}`) : 'Inizia caricando una storia'}
              </div>
              <button disabled=${currentIndex === pages.length-1 || !pages.length} onClick=${()=>setCurrentIndex(currentIndex+1)} className="w-16 h-16 bg-white rounded-full shadow-xl flex items-center justify-center border hover:scale-110 disabled:opacity-20 transition-all text-2xl active:scale-90">‚ùØ</button>
            </div>

            ${pages.length > 0 ? html`
              <div className="relative w-full max-w-5xl aspect-[1.6/1] bg-white rounded-2xl shadow-[0_35px_60px_-15px_rgba(0,0,0,0.3)] flex overflow-hidden ring-1 ring-black/5">
                <div className="book-spine" />
                
                <!-- PAGINA SINISTRA: IMMAGINE -->
                <div className="w-1/2 h-full bg-slate-50 border-r-2 flex items-center justify-center p-12 overflow-hidden relative">
                  ${generatingId === pages[currentIndex].id ? html`
                    <div className="flex flex-col items-center gap-4">
                      <div className="w-24 h-24 shimmer rounded-full shadow-inner" />
                      <p className="text-[10px] font-black uppercase text-indigo-400 animate-pulse tracking-widest">L'AI sta dipingendo...</p>
                    </div>
                  ` : pages[currentIndex].imageUrl ? html`
                    <img src=${pages[currentIndex].imageUrl} className="max-w-full max-h-full object-contain rounded-lg shadow-2xl border-4 border-white" />
                  ` : html`<div className="opacity-10 text-9xl transform rotate-12">üé®</div>`}
                </div>

                <!-- PAGINA DESTRA: TESTO -->
                <div className="w-1/2 h-full bg-white flex flex-col items-center justify-center relative p-16 text-center">
                  ${currentIndex === 0 ? html`
                    <div className="space-y-8">
                      <h2 className="font-playfair text-6xl text-slate-800 leading-tight drop-shadow-sm">${title || 'Mio Libro AI'}</h2>
                      <div className="w-16 h-0.5 bg-indigo-100 mx-auto" />
                      <p className="font-patrick text-3xl text-slate-400 italic">scritto da ${author || 'Anonimo'}</p>
                    </div>
                  ` : html`
                    <textarea 
                      className=${`page-input-style ${settings.fontFamily}`}
                      style=${{ fontSize: `${settings.fontSize}px` }}
                      value=${pages[currentIndex].text}
                      onChange=${e => updateText(currentIndex, e.target.value)}
                    />
                  `}
                  <div className="absolute bottom-8 right-10 text-[10px] font-black text-slate-200 uppercase tracking-widest pointer-events-none">
                    ${currentIndex === 0 ? 'COVER' : `PAG ${currentIndex}`}
                  </div>
                </div>
              </div>
            ` : html`
              <div className="opacity-5 text-[18rem] animate-pulse grayscale">üìñ</div>
            `}

            ${status && html`
              <div className="absolute bottom-8 bg-slate-900/90 backdrop-blur text-white px-8 py-3 rounded-full text-[10px] font-black uppercase tracking-widest shadow-2xl border border-white/10">
                ${status}
              </div>
            `}
          </main>

          <!-- SIDEBAR DESTRA: EDITOR -->
          <aside className="no-print w-80 bg-white border-l shadow-2xl z-50 flex flex-col">
            <div className="p-6 border-b text-center"><h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Personalizza Pagina</h3></div>
            ${pages.length > 0 ? html`
              <div className="flex-1 p-6 space-y-8 overflow-y-auto custom-scrollbar">
                <div className="space-y-4">
                  <label className="text-[11px] font-black uppercase text-indigo-900">Stile Illustrazione</label>
                  <select 
                    value=${pages[currentIndex].styleId}
                    onChange=${e => {
                      const updated = [...pages];
                      updated[currentIndex].styleId = e.target.value;
                      setPages(updated);
                    }}
                    className="w-full p-3 border rounded-xl text-xs font-bold bg-slate-50 outline-none focus:ring-2 ring-indigo-500"
                  >
                    ${STYLES.map(s => html`<option key=${s.id} value=${s.id}>${s.icon} ${s.label}</option>`)}
                  </select>
                  
                  <div className="space-y-2">
                    <label className="text-[9px] font-black text-slate-400 uppercase tracking-widest">Dettagli prompt</label>
                    <textarea 
                      value=${pages[currentIndex].imagePrompt}
                      onChange=${e => {
                        const updated = [...pages];
                        updated[currentIndex].imagePrompt = e.target.value;
                        setPages(updated);
                      }}
                      className="w-full h-28 p-3 text-[10px] border rounded-xl bg-slate-50 outline-none resize-none font-medium leading-relaxed focus:ring-2 ring-indigo-500"
                    />
                  </div>
                  
                  <button onClick=${()=>handleGenerateImage(currentIndex)} disabled=${generatingId !== null} className="w-full py-4 bg-indigo-600 text-white rounded-2xl font-black text-[10px] uppercase shadow-lg hover:bg-indigo-700 active:scale-95 transition-all">
                    Genera Immagine
                  </button>
                </div>

                <div className="space-y-4 pt-8 border-t">
                  <label className="text-[11px] font-black uppercase text-indigo-900 block">Formato Testo</label>
                  <select value=${settings.fontFamily} onChange=${e=>setSettings({...settings, fontFamily: e.target.value})} className="w-full p-3 border rounded-xl text-xs font-bold bg-slate-50 outline-none">
                    ${FONTS.map(f => html`<option key=${f.value} value=${f.value}>${f.label}</option>`)}
                  </select>
                  <div>
                    <input type="range" min="16" max="42" value=${settings.fontSize} onChange=${e=>setSettings({...settings, fontSize: Number(e.target.value)})} className="w-full accent-indigo-600 h-2 bg-slate-100 rounded-lg appearance-none cursor-pointer" />
                    <div className="text-center text-[10px] font-black text-slate-400 mt-2 uppercase tracking-widest">${settings.fontSize}px</div>
                  </div>
                </div>

                <button onClick=${()=>window.print()} className="w-full py-4 bg-slate-900 text-white rounded-2xl font-black text-[10px] uppercase shadow-lg hover:bg-black transition-all active:scale-95">Salva come PDF</button>
              </div>
            ` : html`<div className="p-12 text-center text-xs opacity-30 italic leading-relaxed">Crea lo storyboard per iniziare a personalizzare le tue pagine.</div>`}
          </aside>

          <!-- AREA STAMPA: ESCLUSIVA PER IL MOTORE DI STAMPA -->
          <div id="print-area-root">
            ${pages.map((p, idx) => html`
              <div key=${p.id} className="page-break">
                <!-- PAGINA SX -->
                <div className="w-1/2 h-full flex items-center justify-center p-16">
                  ${p.imageUrl ? html`<img src=${p.imageUrl} className="max-w-full max-h-full object-contain" />` : html`<div className="w-full h-full border-2 border-dashed border-slate-100" />`}
                </div>
                <!-- PAGINA DX -->
                <div className="w-1/2 h-full flex flex-col items-center justify-center text-center p-24">
                  ${idx === 0 ? html`
                    <h1 className="font-playfair text-[80px] mb-8 leading-tight text-slate-900">${title || 'Mio Libro'}</h1>
                    <div className="w-32 h-1 bg-indigo-50 mb-8" />
                    <p className="font-patrick text-4xl text-slate-400 italic">${author || 'Anonimo'}</p>
                  ` : html`
                    <div className=${settings.fontFamily} style=${{ fontSize: `${settings.fontSize}px`, whiteSpace: 'pre-wrap', color: '#1e293b', lineHeight: '1.6' }}>
                      ${p.text}
                    </div>
                  `}
                </div>
              </div>
            `)}
          </div>
        </div>
      `;
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(App));
  </script>
</body>
</html>
