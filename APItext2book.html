
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoryVisualizer AI - Dall'Idea al Libro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/opendyslexic@2/opendyslexic.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Andika&family=Amatic+SC:wght@700&family=Playfair+Display:ital,wght@0,700;1,700&display=swap" rel="stylesheet">
    
    <style>
        .font-opendyslexic { font-family: 'OpenDyslexic', sans-serif; }
        .font-patrick { font-family: 'Patrick Hand', cursive; }
        .font-andika { font-family: 'Andika', sans-serif; }
        .font-amatic { font-family: 'Amatic SC', cursive; }
        .font-playfair { font-family: 'Playfair Display', serif; }
        
        body { background-color: #f8fafc; color: #0f172a; margin: 0; font-family: 'Andika', sans-serif; }

        .book-spread {
            filter: drop-shadow(0 25px 50px rgba(0, 0, 0, 0.1));
            transition: all 0.5s ease;
            max-height: 80vh;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .book-spine {
            background: linear-gradient(to right, rgba(0,0,0,0.02) 0%, rgba(0,0,0,0.08) 50%, rgba(0,0,0,0.02) 100%);
            width: 30px;
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
            pointer-events: none;
        }

        .loader-shimmer {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .print-only { display: none; }

        @media print {
            @page { size: landscape; margin: 0; }
            html, body { height: auto !important; overflow: visible !important; background: white !important; }
            #root { display: block !important; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .print-page {
                page-break-after: always !important;
                display: flex !important;
                flex-direction: row !important;
                width: 100vw !important;
                height: 100vh !important;
                -webkit-print-color-adjust: exact !important;
            }
            .page-side { width: 50% !important; height: 100% !important; overflow: hidden !important; position: relative !important; flex-shrink: 0 !important; }
        }
    </style>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@19.2.3",
        "react-dom/client": "https://esm.sh/react-dom@19.2.3/client",
        "@google/genai": "https://esm.sh/@google/genai@1.38.0"
      }
    }
    </script>
</head>
<body class="h-screen overflow-hidden">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useRef, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { GoogleGenAI, Type } from "@google/genai";

        const STYLES = [
            { id: 'realistic', label: 'Realistico', icon: 'üì∏', prompt: 'photorealistic, cinematic lighting, 8k, masterpiece' },
            { id: 'watercolor', label: 'Acquerello', icon: 'üíß', prompt: 'soft watercolor painting, bleeding colors, storybook style' },
            { id: 'manga', label: 'Manga / Anime', icon: 'üáØüáµ', prompt: 'clean anime style, manga art, vibrant' },
            { id: 'comic', label: 'Fumetto Classico', icon: 'üé®', prompt: 'retro comic book style, bold ink outlines' },
            { id: 'pixelart', label: 'Pixel Art', icon: 'üëæ', prompt: '16-bit retro pixel art, video game style' },
            { id: 'oilpainting', label: 'Olio su Tela', icon: 'üñºÔ∏è', prompt: 'oil painting, thick brushstrokes, canvas texture' },
            { id: '3drender', label: '3D Render (Pixar)', icon: 'üß∏', prompt: 'pixar animation style 3d render, soft lighting' },
            { id: 'pencil', label: 'Schizzo a Matita', icon: '‚úèÔ∏è', prompt: 'detailed pencil sketch, hand drawn' },
            { id: 'popart', label: 'Pop Art', icon: 'üç≠', prompt: 'bold pop art style, andy warhol aesthetic' },
            { id: 'fairytale', label: 'Fiabesco / Magico', icon: 'ü¶Ñ', prompt: 'enchanted fairytale illustration, magical atmosphere' }
        ];

        const App = () => {
            const [pages, setPages] = useState([]);
            const [fullText, setFullText] = useState('');
            const [title, setTitle] = useState('');
            const [author, setAuthor] = useState('');
            const [currentIndex, setCurrentIndex] = useState(0);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [isGeneratingImg, setIsGeneratingImg] = useState(null); 
            const [status, setStatus] = useState('');
            const [numScenes, setNumScenes] = useState(6);
            
            const [manualKey, setManualKey] = useState(localStorage.getItem('gemini_api_key') || '');
            const [settings, setSettings] = useState({
                fontFamily: 'font-patrick',
                fontSize: 22,
                textColor: '#1e293b'
            });

            const fileInputRef = useRef(null);

            useEffect(() => {
                localStorage.setItem('gemini_api_key', manualKey);
            }, [manualKey]);

            // Funzione di retry migliorata con backoff pi√π lungo per errori 429
            const callWithRetry = async (fn, retries = 3, initialDelay = 8000) => {
                let currentDelay = initialDelay;
                for (let i = 0; i < retries; i++) {
                    try {
                        const result = await fn();
                        return result;
                    } catch (err) {
                        const msg = err.message || "";
                        console.error(`Tentativo ${i+1} fallito:`, err);
                        
                        const isRateLimit = msg.includes('429') || 
                                          msg.toLowerCase().includes('quota') || 
                                          msg.toLowerCase().includes('too many requests') ||
                                          msg.toLowerCase().includes('resource has been exhausted');

                        if (isRateLimit && i < retries - 1) {
                            setStatus(`Limite API raggiunto. Attesa di ${currentDelay/1000}s prima di riprovare...`);
                            await new Promise(res => setTimeout(res, currentDelay));
                            currentDelay *= 1.5; // Incremento meno aggressivo per non superare troppo tempo
                            continue;
                        }
                        throw err;
                    }
                }
            };

            const updatePageData = (index, field, value) => {
                setPages(prev => prev.map((p, i) => i === index ? { ...p, [field]: value } : p));
            };

            const cleanJsonResponse = (text) => {
                if (!text) return "";
                // Rimuove eventuali blocchi di codice markdown ```json ... ```
                let cleaned = text.trim();
                if (cleaned.startsWith("```")) {
                    cleaned = cleaned.replace(/^```(?:json)?/, "").replace(/```$/, "");
                }
                return cleaned.trim();
            };

            const analyzeStory = async () => {
                const key = manualKey || process.env.API_KEY;
                if (!key) return alert("Per favore, inserisci una API Key valida.");
                if (!fullText.trim()) return alert("Inserisci il testo della storia per poterla analizzare.");

                setIsAnalyzing(true);
                setStatus('Analisi in corso con Gemini Flash...');
                try {
                    const ai = new GoogleGenAI({ apiKey: key });
                    const prompt = `Analizza questo racconto e dividilo in esattamente ${numScenes} scene per un libro illustrato.
                    Per ogni scena fornisci:
                    1. Un breve testo narrativo adatto alla pagina.
                    2. Un prompt descrittivo dettagliato per generare l'immagine della scena.
                    
                    Rispondi esclusivamente in formato JSON valido:
                    [{"displayText": "testo della pagina", "imagePrompt": "prompt visivo"}]
                    
                    TITOLO: ${title}
                    STORIA: ${fullText}`;

                    const response = await callWithRetry(() => ai.models.generateContent({
                        model: 'gemini-3-flash-preview',
                        contents: prompt,
                        config: { 
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: Type.ARRAY,
                                items: {
                                    type: Type.OBJECT,
                                    properties: {
                                        displayText: { type: Type.STRING },
                                        imagePrompt: { type: Type.STRING }
                                    },
                                    required: ["displayText", "imagePrompt"]
                                }
                            }
                        }
                    }));

                    const rawText = response.text;
                    if (!rawText) throw new Error("L'AI ha restituito una risposta vuota.");
                    
                    const scenes = JSON.parse(cleanJsonResponse(rawText));
                    
                    const newPages = [
                        { id: 'cover', imageUrl: '', text: '', imagePrompt: 'A magnificent book cover illustration for a story titled: ' + title, imageScale: 1, styleId: STYLES[0].id },
                        ...scenes.map((s) => ({
                            id: Math.random().toString(36),
                            imageUrl: '',
                            text: s.displayText,
                            imagePrompt: s.imagePrompt,
                            imageScale: 1,
                            styleId: STYLES[0].id
                        }))
                    ];
                    
                    setPages(newPages);
                    setCurrentIndex(0);
                    setStatus('Storyboard creato! Ora puoi dipingere le scene.');
                } catch (err) { 
                    console.error("Errore Analisi:", err);
                    setStatus(`Errore: ${err.message || 'Controlla la console per dettagli'}`); 
                } finally { setIsAnalyzing(false); }
            };

            const generateImage = async (pageIndex) => {
                const key = manualKey || process.env.API_KEY;
                if (!key) return alert("API Key mancante.");
                
                const page = pages[pageIndex];
                const pageStyle = STYLES.find(s => s.id === page.styleId) || STYLES[0];
                
                setIsGeneratingImg(page.id);
                setStatus(`Pittura della scena in corso...`);
                try {
                    const ai = new GoogleGenAI({ apiKey: key });
                    const finalPrompt = `${page.imagePrompt}. Aesthetic style: ${pageStyle.prompt}. High quality, cinematic masterpiece.`;
                    
                    const response = await callWithRetry(() => ai.models.generateContent({
                        model: 'gemini-2.5-flash-image',
                        contents: finalPrompt,
                        config: { imageConfig: { aspectRatio: "1:1" } }
                    }));
                    
                    let base64 = "";
                    const parts = response.candidates?.[0]?.content?.parts || [];
                    for (const part of parts) {
                        if (part.inlineData) {
                            base64 = `data:image/png;base64,${part.inlineData.data}`;
                            break;
                        }
                    }

                    if (base64) {
                        updatePageData(pageIndex, 'imageUrl', base64);
                        setStatus('Illustrazione completata!');
                    } else {
                        throw new Error("Impossibile recuperare i dati dell'immagine dalla risposta AI.");
                    }
                } catch (err) { 
                    console.error("Errore Immagine:", err);
                    setStatus(`Errore immagine: ${err.message || 'Limite quota?'}`); 
                } finally { setIsGeneratingImg(null); }
            };

            const PageView = ({ page, index, isPrint = false }) => (
                <div className={`flex w-full bg-white book-spread overflow-hidden relative ${isPrint ? 'print-page shadow-none border-none' : 'aspect-[1.6/1] max-w-5xl rounded-xl border'}`}>
                    <div className="book-spine" />
                    <div className="page-side w-1/2 h-full bg-slate-50 border-r relative flex items-center justify-center p-4 overflow-hidden">
                        {isGeneratingImg === page.id ? (
                            <div className="w-full h-full flex flex-col items-center justify-center space-y-4">
                                <div className="w-20 h-20 loader-shimmer rounded-full" />
                                <span className="text-[10px] font-black text-indigo-500 animate-pulse uppercase tracking-widest text-center px-4">L'AI sta dipingendo...</span>
                            </div>
                        ) : page.imageUrl ? (
                            <img src={page.imageUrl} style={{ transform: `scale(${page.imageScale || 1})` }} className="max-w-[90%] max-h-[90%] object-contain shadow-2xl rounded transition-all duration-300" alt="Illustrazione" />
                        ) : (
                            <div className="text-8xl opacity-10 grayscale">üñºÔ∏è</div>
                        )}
                    </div>
                    <div className="page-side w-1/2 h-full bg-white relative flex flex-col items-center justify-center p-12 text-center">
                        {index === 0 ? (
                            <div className="space-y-6">
                                <h1 className="font-playfair text-6xl text-slate-800 leading-tight">{title || "Titolo del Libro"}</h1>
                                <p className="font-patrick text-2xl text-slate-400 italic">di {author || "Autore"}</p>
                            </div>
                        ) : (
                            <div className={`w-full ${settings.fontFamily} leading-relaxed`} style={{ fontSize: `${settings.fontSize}px`, color: settings.textColor }} contentEditable={!isPrint} suppressContentEditableWarning onBlur={(e) => updatePageData(index, 'text', e.currentTarget.innerText)}>
                                {page.text || "Inserisci il testo della scena qui..."}
                            </div>
                        )}
                        <div className="absolute bottom-6 w-full text-center text-[10px] font-black text-slate-200 tracking-widest uppercase">
                            {index === 0 ? "COPERTINA" : `PAGINA ${index}`}
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="flex h-screen bg-slate-100 font-andika overflow-hidden">
                    <div className="print-only">{pages.map((p, i) => <PageView key={p.id} page={p} index={i} isPrint={true} />)}</div>

                    {/* SIDEBAR SINISTRA */}
                    <aside className="no-print w-80 bg-white border-r flex flex-col shadow-2xl z-50">
                        <div className="p-6 border-b bg-slate-900 text-white flex flex-col">
                            <h2 className="text-2xl font-amatic tracking-widest uppercase">‚ú® StoryVisualizer</h2>
                            <p className="text-[8px] text-slate-400 tracking-widest uppercase mt-1">AI Creative Engine</p>
                        </div>
                        <div className="flex-1 overflow-y-auto p-6 space-y-6 custom-scrollbar">
                            <div className="space-y-3">
                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest flex justify-between">
                                    Gemini API Key
                                    {manualKey ? <span className="text-emerald-500">Impostata ‚úì</span> : <span className="text-amber-500">Mancante</span>}
                                </label>
                                <input type="password" placeholder="Incolla API Key" className="w-full p-3 text-xs border rounded-lg focus:ring-1 ring-indigo-400 outline-none" value={manualKey} onChange={e => setManualKey(e.target.value)} />
                                <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-[9px] text-indigo-500 font-bold hover:underline block">Crea una chiave gratuita ‚Üí</a>
                            </div>
                            <div className="space-y-3">
                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Metadati</label>
                                <input type="text" placeholder="Titolo" className="w-full p-3 text-sm border rounded-lg font-bold" value={title} onChange={e => setTitle(e.target.value)} />
                                <input type="text" placeholder="Autore" className="w-full p-3 text-sm border rounded-lg" value={author} onChange={e => setAuthor(e.target.value)} />
                            </div>
                            <div className="space-y-3 pt-4 border-t">
                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">Il tuo Racconto</label>
                                <textarea className="w-full h-44 p-3 text-xs border rounded-lg resize-none outline-none focus:ring-1 ring-slate-300 leading-relaxed" placeholder="Scrivi qui l'idea o la storia..." value={fullText} onChange={e => setFullText(e.target.value)} />
                                <div className="flex justify-between items-center text-[10px] font-bold text-slate-400">
                                    <span>Numero Scene: {numScenes}</span>
                                    <input type="range" min="3" max="12" value={numScenes} onChange={e => setNumScenes(parseInt(e.target.value))} className="accent-slate-900" />
                                </div>
                                <button onClick={analyzeStory} disabled={isAnalyzing || !fullText.trim()} className="w-full py-4 bg-slate-900 text-white rounded-xl font-bold text-[10px] uppercase tracking-widest shadow-lg hover:bg-black transition-all active:scale-95 disabled:opacity-50">
                                    {isAnalyzing ? 'Analisi in corso...' : 'üß† Crea Storyboard'}
                                </button>
                            </div>
                            <div className="pt-4 border-t grid grid-cols-2 gap-2">
                                <button onClick={() => fileInputRef.current.click()} className="py-2.5 bg-slate-100 text-[9px] font-black uppercase rounded-lg border hover:bg-slate-200">üì• Importa</button>
                                <button onClick={() => {
                                    const blob = new Blob([JSON.stringify({title, author, fullText, pages, settings})], {type: 'application/json'});
                                    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${title || 'progetto'}.json`; a.click();
                                }} disabled={pages.length === 0} className="py-2.5 bg-slate-100 text-[9px] font-black uppercase rounded-lg border hover:bg-slate-200">üì§ Esporta</button>
                                <input type="file" ref={fileInputRef} className="hidden" onChange={async (e) => {
                                    const file = e.target.files[0]; if(!file) return;
                                    try {
                                        const data = JSON.parse(await file.text());
                                        setTitle(data.title || ''); setAuthor(data.author || ''); setFullText(data.fullText || ''); 
                                        setPages(data.pages || []); setSettings(data.settings || settings);
                                        setCurrentIndex(0);
                                    } catch (err) { alert("File non valido."); }
                                }} />
                            </div>
                        </div>
                    </aside>

                    {/* AREA CENTRALE LIBRO */}
                    <main className="no-print flex-1 flex flex-col items-center justify-center p-12 bg-slate-50 relative overflow-hidden">
                        <div className="absolute top-10 flex items-center gap-6 z-40">
                            <button onClick={() => setCurrentIndex(Math.max(0, currentIndex - 1))} className="bg-white p-4 rounded-full shadow-lg hover:scale-110 active:scale-95 transition-all disabled:opacity-30" disabled={currentIndex === 0}>‚ùÆ</button>
                            <span className="bg-white px-10 py-3 rounded-full text-[11px] font-black text-slate-500 uppercase tracking-widest border shadow-sm select-none">
                                {pages.length > 0 ? (currentIndex === 0 ? 'COPERTINA' : `SCENA ${currentIndex} / ${pages.length - 1}`) : 'BENVENUTO'}
                            </span>
                            <button onClick={() => setCurrentIndex(Math.min(pages.length - 1, currentIndex + 1))} className="bg-white p-4 rounded-full shadow-lg hover:scale-110 active:scale-95 transition-all disabled:opacity-30" disabled={currentIndex === pages.length - 1}>‚ùØ</button>
                        </div>
                        
                        {pages.length > 0 ? (
                            <div className="w-full flex flex-col items-center animate-in zoom-in duration-300">
                                <PageView page={pages[currentIndex]} index={currentIndex} />
                            </div>
                        ) : (
                            <div className="text-center opacity-10 select-none flex flex-col items-center">
                                <span className="text-[15rem]">üìñ</span>
                                <p className="text-2xl font-black uppercase tracking-widest mt-4">La tua storia inizia qui</p>
                            </div>
                        )}

                        {status && (
                            <div className="absolute bottom-12 px-8 py-3 bg-slate-900 text-white rounded-full shadow-2xl text-[9px] font-black uppercase tracking-[0.2em] animate-pulse z-50 text-center max-w-lg">
                                {status}
                            </div>
                        )}
                    </main>

                    {/* SIDEBAR DESTRA: EDITOR SCENA */}
                    <aside className="no-print w-80 bg-white border-l flex flex-col shadow-2xl z-50">
                        <div className="p-6 border-b">
                            <h3 className="text-[11px] font-black text-slate-400 uppercase tracking-widest">Editor Pagina Attiva</h3>
                        </div>
                        
                        {pages.length > 0 ? (
                            <div className="flex-1 overflow-y-auto p-6 space-y-8 custom-scrollbar">
                                {/* MENU A TENDINA STILI */}
                                <div className="space-y-4">
                                    <label className="text-[10px] font-black text-slate-800 uppercase tracking-widest block">üé® Stile Artistico</label>
                                    <select 
                                        className="w-full p-4 text-xs border rounded-xl bg-slate-50 font-bold outline-none focus:ring-2 ring-indigo-400 cursor-pointer shadow-sm appearance-none"
                                        value={pages[currentIndex].styleId || STYLES[0].id}
                                        onChange={e => updatePageData(currentIndex, 'styleId', e.target.value)}
                                    >
                                        {STYLES.map(style => (
                                            <option key={style.id} value={style.id}>
                                                {style.icon} {style.label}
                                            </option>
                                        ))}
                                    </select>
                                    
                                    <button 
                                        onClick={() => generateImage(currentIndex)}
                                        disabled={isGeneratingImg === pages[currentIndex].id}
                                        className="w-full py-5 bg-indigo-600 text-white rounded-2xl font-bold text-[10px] shadow-xl hover:bg-indigo-700 transition-all uppercase tracking-widest active:scale-95 disabled:opacity-50"
                                    >
                                        {pages[currentIndex].imageUrl ? 'üîÑ Rigenera Illustrazione' : '‚ú® Dipingi con AI'}
                                    </button>
                                </div>

                                <div className="space-y-4 pt-6 border-t">
                                    <label className="text-[10px] font-black text-slate-800 uppercase tracking-widest block">üìù Suggerimento Visivo (Prompt)</label>
                                    <textarea 
                                        className="w-full h-36 p-4 text-[11px] bg-slate-50 border rounded-xl resize-none outline-none focus:ring-1 ring-indigo-300 leading-relaxed font-medium" 
                                        value={pages[currentIndex].imagePrompt} 
                                        onChange={e => updatePageData(currentIndex, 'imagePrompt', e.target.value)} 
                                    />
                                    <div className="flex justify-between items-center text-[9px] font-black text-slate-400 uppercase px-1">
                                        <span>Zoom Immagine</span>
                                        <span className="text-indigo-600 font-bold">{Math.round((pages[currentIndex].imageScale || 1) * 100)}%</span>
                                    </div>
                                    <input type="range" min="0.5" max="2" step="0.05" value={pages[currentIndex].imageScale || 1} onChange={e => updatePageData(currentIndex, 'imageScale', parseFloat(e.target.value))} className="w-full accent-indigo-600" />
                                </div>

                                <div className="space-y-4 pt-6 border-t">
                                    <label className="text-[10px] font-black text-slate-800 uppercase tracking-widest block">üñãÔ∏è Tipografia</label>
                                    <select className="w-full p-3 text-xs border rounded-xl outline-none bg-white font-bold shadow-sm" value={settings.fontFamily} onChange={e => setSettings({...settings, fontFamily: e.target.value})}>
                                        <option value="font-patrick">Patrick Hand (Scritto a mano)</option>
                                        <option value="font-andika">Andika (Standard)</option>
                                        <option value="font-opendyslexic">OpenDyslexic (Accessibilit√†)</option>
                                        <option value="font-playfair">Playfair (Classico)</option>
                                    </select>
                                    <div className="flex justify-between items-center text-[9px] font-black text-slate-400 uppercase px-1">
                                        <span>Dimensione</span>
                                        <span>{settings.fontSize}px</span>
                                    </div>
                                    <input type="range" min="14" max="60" value={settings.fontSize} onChange={e => setSettings({...settings, fontSize: parseInt(e.target.value)})} className="w-full accent-indigo-600" />
                                </div>
                            </div>
                        ) : (
                            <div className="flex-1 flex flex-col items-center justify-center p-8 text-center opacity-30 italic space-y-4">
                                <div className="text-5xl animate-bounce">üé®</div>
                                <p className="text-[10px] font-black uppercase tracking-widest">Inizia l'analisi per sbloccare gli strumenti artistici</p>
                            </div>
                        )}

                        <div className="p-6 border-t mt-auto bg-slate-50/50">
                            <button onClick={() => window.print()} disabled={pages.length === 0} className="w-full py-5 bg-slate-900 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest shadow-xl hover:bg-black transition-all active:scale-95 disabled:opacity-30">üñ®Ô∏è Esporta / PDF</button>
                        </div>
                    </aside>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
