
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Storybook Studio</title>
    
    <!-- Caricamento Librerie Core -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Font Artistici e Accessibili -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/opendyslexic@2/opendyslexic.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Andika&family=Amatic+SC:wght@700&display=swap" rel="stylesheet">
    
    <style>
        .font-opendyslexic { font-family: 'OpenDyslexic', sans-serif; }
        .font-patrick { font-family: 'Patrick Hand', cursive; }
        .font-andika { font-family: 'Andika', sans-serif; }
        .font-amatic { font-family: 'Amatic SC', cursive; }
        
        body { background-color: #f8fafc; color: #1e293b; margin: 0; font-family: 'Andika', sans-serif; }

        .book-container {
            filter: drop-shadow(0 25px 50px rgba(0, 0, 0, 0.15));
            transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
            main { padding: 0 !important; margin: 0 !important; width: 100% !important; }
            .print-page {
                page-break-after: always;
                display: flex !important;
                width: 100vw !important;
                height: 100vh !important;
                box-shadow: none !important;
                border: none !important;
            }
        }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        
        .thumb-active { border-color: #6366f1; transform: scale(1.05); z-index: 10; shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    </style>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@19.2.3",
        "react-dom/client": "https://esm.sh/react-dom@19.2.3/client",
        "@google/genai": "https://esm.sh/@google/genai@1.38.0"
      }
    }
    </script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="antialiased h-screen overflow-hidden">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { GoogleGenAI, Type } from "@google/genai";

        const PIXABAY_KEY = '39756291-adb90e835df2d9254a2cdcdd3';

        const generateId = () => Math.random().toString(36).substring(2, 9);

        const resizeImage = async (dataUrl) => {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = dataUrl;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const maxDim = 800;
                    let w = img.width, h = img.height;
                    if (w > h) { if (w > maxDim) { h *= maxDim / w; w = maxDim; } }
                    else { if (h > maxDim) { w *= maxDim / h; h = maxDim; } }
                    canvas.width = w; canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', 0.8));
                };
            });
        };

        const App = () => {
            const [pages, setPages] = useState([]);
            const [title, setTitle] = useState('');
            const [author, setAuthor] = useState('');
            const [currentIndex, setCurrentIndex] = useState(0);
            const [isGenerating, setIsGenerating] = useState(false);
            const [status, setStatus] = useState('');
            const [pixabayQuery, setPixabayQuery] = useState('');
            const [pixabayResults, setPixabayResults] = useState([]);
            const [draggedIdx, setDraggedIdx] = useState(null);

            const [settings, setSettings] = useState({
                fontFamily: 'font-patrick',
                fontSize: 24,
                textColor: '#1e293b',
                bgOpacity: 0.9
            });

            const fileInputRef = useRef(null);

            const searchPixabay = async () => {
                if (!pixabayQuery) return;
                setStatus('Ricerca...');
                try {
                    const response = await fetch(`https://pixabay.com/api/?key=${PIXABAY_KEY}&q=${encodeURIComponent(pixabayQuery)}&image_type=photo&per_page=15`);
                    const data = await response.json();
                    setPixabayResults(data.hits || []);
                } catch (err) { setStatus('Errore di rete'); }
                finally { setStatus(''); }
            };

            const addImage = async (url) => {
                setStatus('Caricamento...');
                try {
                    const response = await fetch(url);
                    const blob = await response.blob();
                    const reader = new FileReader();
                    const dataUrl = await new Promise(res => {
                        reader.onloadend = () => res(reader.result);
                        reader.readAsDataURL(blob);
                    });
                    const resized = await resizeImage(dataUrl);
                    setPages(prev => [...prev, { id: generateId(), imageUrl: resized, text: '' }]);
                } catch (e) { setStatus('Errore immagine'); }
                setStatus('');
            };

            const handleFileUpload = async (e) => {
                const files = e.target.files;
                if (!files?.length) return;
                setStatus('Elaborazione...');
                for (let file of files) {
                    const reader = new FileReader();
                    const dataUrl = await new Promise(r => {
                        reader.onload = ev => r(ev.target?.result);
                        reader.readAsDataURL(file);
                    });
                    const resized = await resizeImage(dataUrl);
                    setPages(prev => [...prev, { id: generateId(), imageUrl: resized, text: '' }]);
                }
                setStatus('');
            };

            const generateStory = async () => {
                if (!title || !author) return alert("Per favore, inserisci Titolo e Autore.");
                if (pages.length < 2) return alert("Carica almeno 2 immagini per comporre il libro.");

                setIsGenerating(true);
                setStatus('L\'AI sta scrivendo...');

                try {
                    const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
                    const imageParts = pages.map(p => ({
                        inlineData: { mimeType: 'image/jpeg', data: p.imageUrl.split(',')[1] }
                    }));

                    const response = await ai.models.generateContent({
                        model: 'gemini-3-flash-preview',
                        contents: { parts: imageParts },
                        config: {
                            systemInstruction: `Sei un autore di libri illustrati per bambini. 
                            Osserva queste immagini e scrivi una storia coerente in ITALIANO.
                            L'immagine 0 √® la copertina: restituisci una stringa vuota "".
                            Per tutte le altre immagini, scrivi un paragrafo narrativo (max 40 parole) che descriva l'azione.
                            REQUISITO: Restituisci esclusivamente un array JSON di stringhe di lunghezza ${pages.length}.`,
                            responseMimeType: "application/json",
                            responseSchema: { type: Type.ARRAY, items: { type: Type.STRING } }
                        }
                    });

                    const storyContent = JSON.parse(response.text || "[]");
                    setPages(prev => prev.map((p, i) => ({ ...p, text: storyContent[i] || p.text })));
                    setStatus('Fatto! üéâ');
                } catch (error) {
                    console.error(error);
                    setStatus('Errore AI');
                    alert("Si √® verificato un problema con l'AI. Verifica la connessione o riprova.");
                } finally {
                    setIsGenerating(false);
                    setTimeout(() => setStatus(''), 3000);
                }
            };

            const BookPage = ({ page, index, isPrint = false }) => (
                <div className={`flex w-full max-w-5xl aspect-[1.618/1] bg-white book-container overflow-hidden relative ${isPrint ? 'print-page' : 'rounded-2xl sm:rounded-[2rem]'}`}>
                    {/* Pagina Sinistra (Immagine) */}
                    <div className="w-1/2 h-full bg-slate-50 border-r border-slate-100 relative overflow-hidden">
                        {index === 0 ? (
                            <div className="w-full h-full flex flex-col items-center justify-center p-12 text-slate-200">
                                <span className="text-9xl mb-4">üìñ</span>
                                <span className="text-xs font-black tracking-[0.4em] uppercase">Cover</span>
                            </div>
                        ) : (
                            <div className="w-full h-full bg-cover bg-center transition-all duration-700" style={{ backgroundImage: `url(${page.imageUrl})` }} />
                        )}
                        <div className="absolute inset-y-0 right-0 w-24 bg-gradient-to-l from-black/[0.03] to-transparent pointer-events-none" />
                    </div>

                    {/* Pagina Destra (Testo) */}
                    <div className="w-1/2 h-full p-10 sm:p-16 relative flex flex-col items-center justify-center text-center bg-white">
                        <div className="absolute inset-y-0 left-0 w-24 bg-gradient-to-r from-black/[0.03] to-transparent pointer-events-none" />
                        <div 
                            className={`w-full z-10 transition-all leading-relaxed ${settings.fontFamily}`}
                            style={{ 
                                fontSize: index === 0 ? `${settings.fontSize * 1.5}px` : `${settings.fontSize}px`,
                                color: settings.textColor,
                                backgroundColor: index === 0 ? 'transparent' : `rgba(255,255,255,${settings.bgOpacity})`,
                                borderRadius: '1.5rem',
                                padding: index === 0 ? '0' : '1.5rem'
                            }}
                            contentEditable={!isPrint && index !== 0}
                            suppressContentEditableWarning
                            onBlur={(e) => {
                                const up = [...pages];
                                up[index].text = e.currentTarget.innerText;
                                setPages(up);
                            }}
                        >
                            {index === 0 ? (
                                <div className="space-y-6">
                                    <h1 className="font-amatic text-7xl sm:text-8xl text-indigo-900 leading-tight">{title || "Il Mio Libro"}</h1>
                                    <div className="w-16 h-1 bg-indigo-400 mx-auto rounded-full" />
                                    <p className="text-xl italic text-slate-400 font-medium">di {author || "..."}</p>
                                </div>
                            ) : (
                                page.text || (isPrint ? "" : "Scrivi qui o usa 'Genera'...")
                            )}
                        </div>
                        <div className="absolute bottom-6 left-1/2 -translate-x-1/2 text-[10px] text-slate-200 font-black tracking-widest uppercase">
                            {index === 0 ? "Titolo" : `Pag. ${index}`}
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="flex flex-col md:flex-row h-screen bg-[#f8fafc]">
                    
                    {/* ASIDE SX: TOOLS */}
                    <aside className="no-print w-full md:w-80 bg-white border-r flex flex-col shadow-2xl z-50 overflow-hidden">
                        <div className="p-6 border-b bg-indigo-50/30">
                            <h2 className="text-2xl font-amatic text-indigo-600 mb-6 flex items-center gap-2"><span>üé®</span> Editor Studio</h2>
                            <div className="space-y-3">
                                <input type="text" placeholder="Titolo della storia" className="w-full p-4 border rounded-2xl text-sm outline-none focus:ring-2 ring-indigo-200 transition-all" value={title} onChange={e => setTitle(e.target.value)} />
                                <input type="text" placeholder="Nome autore" className="w-full p-4 border rounded-2xl text-sm outline-none focus:ring-2 ring-indigo-200 transition-all" value={author} onChange={e => setAuthor(e.target.value)} />
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto p-6 space-y-8 custom-scroll">
                            <button onClick={generateStory} disabled={isGenerating} className={`w-full py-5 rounded-3xl font-black text-white shadow-xl flex items-center justify-center gap-2 transition-transform active:scale-95 ${isGenerating ? 'bg-slate-300' : 'bg-gradient-to-br from-indigo-600 to-violet-700 hover:opacity-95'}`}>
                                {isGenerating ? <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin" /> : '‚ú®'}
                                {isGenerating ? 'AI Scrittura...' : 'GENERA STORIA'}
                            </button>
                            
                            {status && <p className="text-[10px] text-center font-black text-indigo-400 uppercase tracking-widest animate-pulse">{status}</p>}

                            <div className="space-y-4">
                                <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest">üîç Cerca Immagini</h3>
                                <div className="flex gap-2">
                                    <input type="text" placeholder="Es: bosco incantato" className="flex-1 p-3 text-xs border rounded-xl outline-none bg-slate-50" value={pixabayQuery} onChange={e => setPixabayQuery(e.target.value)} onKeyDown={e => e.key === 'Enter' && searchPixabay()} />
                                    <button onClick={searchPixabay} className="bg-indigo-600 text-white px-4 py-2 rounded-xl text-xs font-bold hover:bg-indigo-700">Vai</button>
                                </div>
                                <div className="grid grid-cols-3 gap-2 max-h-48 overflow-y-auto pr-1 custom-scroll">
                                    {pixabayResults.map(h => (
                                        <img key={h.id} src={h.previewURL} className="cursor-pointer rounded-lg border-2 border-transparent h-16 w-full object-cover hover:border-indigo-400 transition-all" onClick={() => addImage(h.webformatURL)} />
                                    ))}
                                </div>
                            </div>

                            <div className="space-y-4 pt-4 border-t">
                                <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest flex justify-between">Pagine <span>{pages.length}</span></h3>
                                <div className="grid grid-cols-2 gap-3">
                                    {pages.map((p, i) => (
                                        <div 
                                            key={p.id} 
                                            draggable 
                                            onDragStart={() => setDraggedIdx(i)}
                                            onDragOver={e => e.preventDefault()}
                                            onDrop={() => {
                                                if (draggedIdx === null) return;
                                                const up = [...pages];
                                                const [moved] = up.splice(draggedIdx, 1);
                                                up.splice(i, 0, moved);
                                                setPages(up);
                                                setDraggedIdx(null);
                                                setCurrentIndex(i);
                                            }}
                                            className={`relative group rounded-xl overflow-hidden border-2 cursor-pointer transition-all ${currentIndex === i ? 'thumb-active' : 'border-transparent opacity-60'}`}
                                            onClick={() => setCurrentIndex(i)}
                                        >
                                            <div className="aspect-video bg-cover bg-center" style={{ backgroundImage: `url(${p.imageUrl})` }} />
                                            <button onClick={e => { e.stopPropagation(); setPages(pages.filter((_, idx) => idx !== i)); }} className="absolute top-1 right-1 bg-red-500 text-white w-5 h-5 rounded-full flex items-center justify-center text-[10px] opacity-0 group-hover:opacity-100 shadow-lg">√ó</button>
                                        </div>
                                    ))}
                                </div>
                                <button onClick={() => fileInputRef.current.click()} className="w-full border-2 border-dashed border-slate-200 py-4 rounded-2xl text-[10px] font-black text-slate-400 hover:bg-slate-50 transition-colors uppercase tracking-widest">üìÅ Carica Foto</button>
                                <input type="file" ref={fileInputRef} multiple accept="image/*" className="hidden" onChange={handleFileUpload} />
                            </div>
                        </div>
                    </aside>

                    {/* MAIN: VIEWPORT */}
                    <main className="flex-1 flex flex-col items-center justify-center p-6 relative overflow-hidden">
                        {/* Print View */}
                        <div className="hidden print:block w-full">
                            {pages.map((p, i) => <BookPage key={p.id} page={p} index={i} isPrint={true} />)}
                        </div>

                        {/* Navigation Overlay */}
                        <div className="no-print absolute top-10 flex items-center gap-6 z-40">
                            <button onClick={() => setCurrentIndex(Math.max(0, currentIndex - 1))} className="bg-white/90 backdrop-blur p-4 rounded-full shadow-lg hover:bg-white disabled:opacity-20 transition-all" disabled={currentIndex === 0}>‚ùÆ</button>
                            <div className="bg-white/80 backdrop-blur px-8 py-2 rounded-full text-xs font-black text-slate-400 uppercase tracking-[0.3em] shadow-sm">
                                {pages.length > 0 ? (currentIndex === 0 ? 'Copertina' : `Pagina ${currentIndex}`) : 'Pronto'}
                            </div>
                            <button onClick={() => setCurrentIndex(Math.min(pages.length - 1, currentIndex + 1))} className="bg-white/90 backdrop-blur p-4 rounded-full shadow-lg hover:bg-white disabled:opacity-20 transition-all" disabled={currentIndex === pages.length - 1}>‚ùØ</button>
                        </div>

                        {/* Current Page View */}
                        {pages.length > 0 ? (
                            <div className="no-print w-full flex justify-center px-4 animate-in fade-in duration-1000">
                                <BookPage page={pages[currentIndex]} index={currentIndex} />
                            </div>
                        ) : (
                            <div className="text-slate-200 text-center select-none animate-bounce">
                                <div className="text-[10rem] opacity-20 mb-4">üìö</div>
                                <p className="text-2xl font-amatic">Inizia a comporre il tuo libro!</p>
                            </div>
                        )}
                    </main>

                    {/* ASIDE DX: STYLE */}
                    <aside className="no-print w-full md:w-72 bg-white border-l p-8 flex flex-col shadow-2xl z-50">
                        <h3 className="font-amatic text-2xl font-bold border-b pb-4 mb-10 text-slate-700">Personalizza</h3>
                        <div className="space-y-10 flex-1">
                            <div className="space-y-4">
                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Carattere</label>
                                <select className="w-full p-4 bg-slate-50 border rounded-2xl text-sm font-bold outline-none cursor-pointer hover:bg-slate-100 transition-all" value={settings.fontFamily} onChange={e => setSettings({...settings, fontFamily: e.target.value})}>
                                    <option value="font-patrick">Scrittura a mano</option>
                                    <option value="font-opendyslexic">Accessibile (Dyslexic)</option>
                                    <option value="font-andika">Andika (Standard)</option>
                                    <option value="font-amatic">Artistico (Grande)</option>
                                </select>
                            </div>
                            <div className="space-y-4">
                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest flex justify-between">Testo <span>{settings.fontSize}px</span></label>
                                <input type="range" min="16" max="60" className="w-full h-2 bg-slate-100 rounded-lg appearance-none cursor-pointer accent-indigo-600" value={settings.fontSize} onChange={e => setSettings({...settings, fontSize: parseInt(e.target.value)})} />
                            </div>
                            <div className="space-y-4">
                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Colore</label>
                                <div className="flex gap-3 items-center">
                                    <input type="color" className="w-12 h-12 rounded-xl cursor-pointer p-0 border-none bg-transparent" value={settings.textColor} onChange={e => setSettings({...settings, textColor: e.target.value})} />
                                    <span className="text-xs font-mono text-slate-400 uppercase">{settings.textColor}</span>
                                </div>
                            </div>
                            <div className="space-y-4">
                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest flex justify-between">Opacit√† sfondo <span>{Math.round(settings.bgOpacity*100)}%</span></label>
                                <input type="range" min="0" max="1" step="0.05" className="w-full h-2 bg-slate-100 rounded-lg appearance-none cursor-pointer accent-indigo-600" value={settings.bgOpacity} onChange={e => setSettings({...settings, bgOpacity: parseFloat(e.target.value)})} />
                            </div>
                        </div>
                        
                        <div className="pt-8 border-t">
                            <button onClick={() => window.print()} disabled={pages.length === 0} className="w-full bg-slate-900 text-white py-5 rounded-3xl font-black text-xs uppercase tracking-[0.2em] hover:bg-black transition-all active:scale-95 disabled:opacity-20 flex items-center justify-center gap-2">
                                <span>üñ®Ô∏è</span> Stampa o PDF
                            </button>
                        </div>
                    </aside>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
